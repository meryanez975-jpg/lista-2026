<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- PWA -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#7c3aed">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Conteo semanal</title>
  <link rel="stylesheet" href="../estilo.css">
  <style>
    body { background: linear-gradient(160deg, #ffe8c0 0%, #fff8ee 40%, #fffff8 100%); }
    .conteo-header {
      background: linear-gradient(135deg, #e65100, #ef6c00, #ffa726);
      border-radius: 0 0 36px 36px;
      padding: 32px 24px 28px;
      text-align: center;
      margin-bottom: 24px;
      box-shadow: 0 6px 20px rgba(230,81,0,.22);
      position: relative; overflow: hidden;
    }
    .conteo-header::before {
      content:""; position:absolute; top:-30px; right:-30px;
      width:120px; height:120px; background:rgba(255,255,255,.10); border-radius:50%;
    }
    .conteo-header .icon-grande { font-size:52px; display:block; margin-bottom:8px; }
    .conteo-header h1 { margin:0 0 4px; color:#fff; font-size:26px; font-weight:900; text-shadow:0 2px 6px rgba(0,0,0,.2); }
    .conteo-header p  { margin:0; color:rgba(255,255,255,.85); font-size:13px; }
    .panel { padding-top: 0 !important; }
    .form-card { border-color: #ffcc80; }

    /* Tarjetas de comida */
    .comida-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 14px; }
    .comida-tile {
      background: #fff; border: 2px solid #ffcc80; border-radius: 18px;
      padding: 18px 10px; text-align: center; cursor: pointer;
      box-shadow: 0 4px 12px rgba(230,81,0,.08); transition: transform .1s;
    }
    .comida-tile:active { transform: scale(0.97); }
    .comida-tile .tile-icon { font-size: 36px; display: block; margin-bottom: 6px; }
    .comida-tile .tile-name { font-size: 14px; font-weight: 800; color: #5a2d00; }

    /* Sub-view */
    #subView { animation: fadeIn .15s ease; }
    .sub-header {
      display: flex; align-items: center; gap: 12px; margin-bottom: 14px; flex-wrap: wrap;
    }
    .btn-volver-sub {
      padding: 8px 14px; border: 1.5px solid #ffcc80; border-radius: 12px;
      background: #fff8ee; color: #7a4200; font-size: 13px; font-weight: 700;
      cursor: pointer; white-space: nowrap;
    }
    .sub-titulo { font-size: 20px; font-weight: 900; color: #5a2d00; }

    /* Navegaci√≥n de semana */
    .semana-nav {
      display: flex; align-items: center; justify-content: space-between;
      background: #fff8ee; border: 2px solid #ffcc80; border-radius: 14px;
      padding: 10px 14px; margin-bottom: 14px;
    }
    .semana-nav-btn {
      background: #ffd6a5; border: none; border-radius: 10px;
      padding: 8px 14px; font-size: 16px; font-weight: 900; color: #7a4200; cursor: pointer;
    }
    .semana-nav-btn:active { opacity: .7; }
    .semana-nav-label { font-size: 13px; font-weight: 800; color: #5a2d00; text-align: center; }

    /* Tabla semanal */
    .tabla-semana {
      width: 100%; border-collapse: collapse; font-size: 12px; min-width: 480px;
    }
    .tabla-semana th {
      background: #ffd6a5; padding: 8px 6px; text-align: center;
      font-weight: 800; border-bottom: 2px solid #ffb74d; white-space: nowrap;
    }
    .tabla-semana th:first-child { text-align: left; padding-left: 10px; min-width: 80px; }
    .tabla-semana td {
      padding: 6px; border-bottom: 1px solid #fff3e0; vertical-align: middle;
      text-align: center; font-size: 12px;
    }
    .tabla-semana td:first-child { text-align: left; padding-left: 10px; font-weight: 600; }
    .tabla-semana tr:last-child td { border-bottom: none; }

    /* Encabezado de sector */
    .sector-titulo-card {
      background: linear-gradient(135deg, #ef6c00, #ffa726);
      color: #fff; font-weight: 900; font-size: 13px; letter-spacing: .5px;
      padding: 8px 14px; border-radius: 12px 12px 0 0;
      text-transform: uppercase;
    }

    /* Celda con nombre (SI) */
    .celda-nombre {
      color: #1b5e20; font-weight: 800; font-size: 12px;
    }
    /* Celda libre */
    .celda-libre {
      background: #fff9c4; color: #7a5900; font-weight: 900; font-size: 11px;
      border-radius: 6px; padding: 2px 5px; display: inline-block;
    }
    /* Fila total */
    .total-row td {
      background: #fff3e0; font-weight: 900; font-size: 13px;
      color: #5a2d00; border-top: 2px solid #ffb74d; padding: 7px 6px !important;
    }
    .total-row td:first-child { padding-left: 10px !important; }
    /* Gran total */
    .gran-total-row td {
      background: #ffd6a5; font-weight: 900; font-size: 14px;
      color: #3a1a00; border-top: 3px solid #ef6c00; padding: 8px 6px !important;
    }
    .gran-total-row td:first-child { padding-left: 10px !important; }
    /* D√≠a de hoy resaltado */
    .th-hoy { background: #ef6c00 !important; color: #fff !important; }

    /* Botones de acci√≥n */
    .action-btns { display: flex; gap: 10px; margin-bottom: 12px; flex-wrap: wrap; }
    .action-btns .btn-mini { flex: 1; min-width: 90px; text-align: center; }

    @media print {
      .no-print { display: none !important; }
      body { background: #fff; padding: 0; display: block; }
      .panel { width: 100% !important; }
      .form-card { box-shadow: none !important; border: 1px solid #ddd; }
    }
  </style>
</head>
<body>

<main class="panel" style="padding-top:0;">
  <div class="conteo-header no-print">
    <span class="icon-grande">üßÆ</span>
    <h1>Conteo semanal</h1>
    <p>Resumen de comidas por persona y d√≠a</p>
  </div>

  <!-- ===== VISTA PRINCIPAL ===== -->
  <div id="mainView">
    <section class="form-card">
      <h4 style="margin:0 0 12px; color:#7a4200;">Seleccion√° una comida</h4>
      <div class="comida-grid">
        <div class="comida-tile" onclick="abrirComida('desayuno')">
          <span class="tile-icon">üçû</span>
          <span class="tile-name">DESAYUNO</span>
        </div>
        <div class="comida-tile" onclick="abrirComida('almuerzo')">
          <span class="tile-icon">üçõ</span>
          <span class="tile-name">ALMUERZO</span>
        </div>
        <div class="comida-tile" onclick="abrirComida('merienda')">
          <span class="tile-icon">ü•ê</span>
          <span class="tile-name">MERIENDA</span>
        </div>
        <div class="comida-tile" onclick="abrirComida('cena')">
          <span class="tile-icon">üç≤</span>
          <span class="tile-name">CENA</span>
        </div>
      </div>
    </section>
    <a class="btn-volver-bottom no-print" href="../index.html">‚¨Ö Volver al inicio</a>
  </div>

  <!-- ===== SUB-VIEW: Tabla semanal de una comida ===== -->
  <div id="subView" class="hidden">
    <section class="form-card">
      <div class="sub-header no-print">
        <button class="btn-volver-sub" id="btnVolverMain" type="button">‚Üê Comidas</button>
        <span class="sub-titulo" id="subTitulo"></span>
      </div>

      <!-- Navegador de semana -->
      <div class="semana-nav no-print">
        <button class="semana-nav-btn" id="btnPrevWeek" type="button">‚óÄ</button>
        <span class="semana-nav-label" id="rangoSemana">‚Äî</span>
        <button class="semana-nav-btn" id="btnNextWeek" type="button">‚ñ∂</button>
      </div>

      <!-- Botones de acci√≥n -->
      <div class="action-btns no-print">
        <button class="btn-mini" id="btnExportWord" type="button">üìÑ Descargar Word</button>
      </div>

      <p class="nota" id="msgConteo"></p>

      <!-- Tablas por sector -->
      <div id="resultadosWrap" class="hidden">
        <div id="sectoresTablas"></div>
      </div>
    </section>

    <div class="no-print" style="margin-top:8px;">
      <a class="btn-volver-bottom" href="../index.html">‚¨Ö Volver al inicio</a>
    </div>
  </div>

</main>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script src="../firebase-config.js"></script>
<script>
if (sessionStorage.getItem("admin_logged") !== "1" && !["admin","supervisor"].includes(sessionStorage.getItem("rol_activo"))) window.location.href = "../index.html";

const mainView       = document.getElementById("mainView");
const subView        = document.getElementById("subView");
const subTitulo      = document.getElementById("subTitulo");
const msgConteo      = document.getElementById("msgConteo");
const resultadosWrap = document.getElementById("resultadosWrap");
const sectoresTablas = document.getElementById("sectoresTablas");

let comidaActual = null;
let weekStart    = startOfWeekMonday(new Date());
let ultimosDatos = null;

// ===== ACTUALIZAR RANGO Y CARGAR =====
function actualizarSemana() {
  const fin  = addDays(weekStart, 6);
  const meses = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
  document.getElementById("rangoSemana").textContent =
    `${weekStart.getDate()} ${meses[weekStart.getMonth()]} ‚Äì ${fin.getDate()} ${meses[fin.getMonth()]} ${fin.getFullYear()}`;
  if (comidaActual) calcular();
}

document.getElementById("btnPrevWeek").addEventListener("click", () => {
  weekStart = addDays(weekStart, -7); actualizarSemana();
});
document.getElementById("btnNextWeek").addEventListener("click", () => {
  weekStart = addDays(weekStart,  7); actualizarSemana();
});

// ===== ABRIR COMIDA =====
function abrirComida(meal) {
  comidaActual = meal;
  subTitulo.textContent = `${COMIDA_ICON[meal]} ${COMIDA_LABEL[meal]}`;
  resultadosWrap.classList.add("hidden");
  msgConteo.textContent = "";
  ultimosDatos = null;
  mainView.classList.add("hidden");
  subView.classList.remove("hidden");
  window.scrollTo({ top: 0, behavior: "smooth" });
  actualizarSemana();
}

document.getElementById("btnVolverMain").addEventListener("click", () => {
  subView.classList.add("hidden");
  mainView.classList.remove("hidden");
  comidaActual = null;
  window.scrollTo({ top: 0, behavior: "smooth" });
});

// ===== HELPER: ¬øel extra aplica en esta fecha? =====
function extraAplicaEnFecha(e, fecha) {
  if (!e.activo) return false;
  if (e.duracion === "dia") return e.fechaRef === fecha;
  if (e.duracion === "semana") {
    const semExtra = iso(startOfWeekMonday(new Date(e.fechaRef + "T00:00:00")));
    const semFecha = iso(startOfWeekMonday(new Date(fecha + "T00:00:00")));
    return semExtra === semFecha;
  }
  // permanente: siempre aplica
  return true;
}

// ===== CALCULAR SEMANA =====
async function calcular() {
  msgConteo.textContent = "Cargando...";
  resultadosWrap.classList.add("hidden");
  ultimosDatos = null;

  try {
    const [personalData, registrosData, extrasData] = await Promise.all([
      dbGet("personal"),
      dbGet("registros"),
      dbGet("extras")
    ]);

    if (!personalData) { msgConteo.textContent = "No hay personal registrado."; return; }

    const personas = Object.entries(personalData)
      .filter(([, p]) => p.activo && comidasDeTurno(p.turno).includes(comidaActual))
      .map(([key, p]) => ({ key, ...p }))
      .sort((a, b) => (a.nombre || "").localeCompare(b.nombre || "", "es"));

    const fechas = Array.from({ length: 7 }, (_, i) => iso(addDays(weekStart, i)));
    const hoyISO = iso(new Date());

    // Encabezado de columnas de d√≠as
    const thDias = fechas.map((f, i) => {
      const esHoy = f === hoyISO;
      return `<th class="${esHoy ? "th-hoy" : ""}">${DIA_CORTO[i]}<br>
        <span style="font-weight:500;font-size:10px;">${formatDM(f)}</span></th>`;
    }).join("");

    const porSector = {};
    SECTORES.forEach(s => porSector[s] = []);
    personas.forEach(p => {
      const s = p.sector || "otros";
      if (!porSector[s]) porSector[s] = [];
      porSector[s].push(p);
    });

    const granTotalPorDia = Array(7).fill(0);
    let htmlSectores = "";

    SECTORES.forEach(s => {
      const lista = porSector[s] || [];
      if (!lista.length) return;
      const sLabel = s.charAt(0).toUpperCase() + s.slice(1);

      const totalSectorDia = Array(7).fill(0);

      const filaPersonas = lista.map(p => {
        const celdas = fechas.map((fecha, i) => {
          const dt = new Date(fecha + "T00:00:00");
          const weekIdx = dt.getDay() === 0 ? 6 : dt.getDay() - 1;

          if (esDiaLibre(p, weekIdx)) {
            return `<td><span class="celda-libre">LIBRE</span></td>`;
          }

          const val = registrosData?.[p.key]?.[fecha]?.[comidaActual];
          if (val === "SI") {
            totalSectorDia[i]++;
            granTotalPorDia[i]++;
            return `<td class="celda-nombre">${p.nombre}</td>`;
          }
          return `<td></td>`;
        }).join("");

        return `<tr><td>${p.nombre}</td>${celdas}</tr>`;
      }).join("");

      const filaTotalSector = `<tr class="total-row">
        <td>Total</td>
        ${totalSectorDia.map(t => `<td>${t > 0 ? t : ""}</td>`).join("")}
      </tr>`;

      htmlSectores += `
        <div style="margin-bottom:16px; border-radius:12px; overflow:hidden; border:2px solid #ffcc80;">
          <div class="sector-titulo-card">${sLabel}</div>
          <div style="overflow-x:auto;">
            <table class="tabla-semana">
              <thead><tr><th>Nombre</th>${thDias}</tr></thead>
              <tbody>${filaPersonas}${filaTotalSector}</tbody>
            </table>
          </div>
        </div>`;
    });

    // ===== EXTRAS =====
    if (extrasData) {
      const extrasActivos = Object.entries(extrasData)
        .filter(([, e]) => e.activo && (e.comidas || []).includes(comidaActual))
        .map(([key, e]) => ({ key, ...e }))
        .sort((a, b) => (a.nombre || "").localeCompare(b.nombre || "", "es"));

      if (extrasActivos.length) {
        const totalExtrasDia = Array(7).fill(0);

        const filasExtras = extrasActivos.map(e => {
          const celdas = fechas.map((fecha, i) => {
            if (extraAplicaEnFecha(e, fecha)) {
              totalExtrasDia[i]++;
              granTotalPorDia[i]++;
              return `<td class="celda-nombre">${e.nombre}</td>`;
            }
            return `<td></td>`;
          }).join("");
          return `<tr><td>${e.nombre}</td>${celdas}</tr>`;
        }).join("");

        const filaTotalExtras = `<tr class="total-row">
          <td>Total</td>
          ${totalExtrasDia.map(t => `<td>${t > 0 ? t : ""}</td>`).join("")}
        </tr>`;

        htmlSectores += `
          <div style="margin-bottom:16px; border-radius:12px; overflow:hidden; border:2px solid #ce93d8;">
            <div class="sector-titulo-card" style="background:linear-gradient(135deg,#4527a0,#7c3aed);">‚≠ê PERSONAL EXTRA</div>
            <div style="overflow-x:auto;">
              <table class="tabla-semana">
                <thead><tr><th>Nombre</th>${thDias}</tr></thead>
                <tbody>${filasExtras}${filaTotalExtras}</tbody>
              </table>
            </div>
          </div>`;
      }
    }

    // Gran total al final
    htmlSectores += `
      <div style="border-radius:12px; overflow:hidden; border:3px solid #ef6c00;">
        <div style="background:#ef6c00;color:#fff;font-weight:900;font-size:14px;padding:8px 14px;text-transform:uppercase;">
          TOTAL GENERAL ‚Äî ${COMIDA_LABEL[comidaActual]}
        </div>
        <div style="overflow-x:auto;">
          <table class="tabla-semana">
            <thead><tr><th></th>${thDias}</tr></thead>
            <tbody><tr class="gran-total-row">
              <td>Total comidas</td>
              ${granTotalPorDia.map(t => `<td>${t > 0 ? t : "‚Äî"}</td>`).join("")}
            </tr></tbody>
          </table>
        </div>
      </div>`;

    sectoresTablas.innerHTML = htmlSectores;
    resultadosWrap.classList.remove("hidden");
    msgConteo.textContent = "";

    ultimosDatos = { personas, registrosData, fechas, meal: comidaActual };

  } catch {
    msgConteo.textContent = "‚ùå Error al cargar. Verifica el WiFi.";
  }
}

// ===== DESCARGAR WORD =====
document.getElementById("btnExportWord").addEventListener("click", () => {
  if (!ultimosDatos) { msgConteo.textContent = "Esper√° que cargue primero."; return; }
  const { meal } = ultimosDatos;
  const fin = addDays(weekStart, 6);
  const meses = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
  const rango = `${weekStart.getDate()} ${meses[weekStart.getMonth()]} ‚Äì ${fin.getDate()} ${meses[fin.getMonth()]} ${fin.getFullYear()}`;
  const titulo = `Conteo ${COMIDA_LABEL[meal]} ‚Äî Semana ${rango}`;

  const contenido = sectoresTablas.innerHTML;
  const html = `<html xmlns:o='urn:schemas-microsoft-com:office:office'
    xmlns:w='urn:schemas-microsoft-com:office:word'
    xmlns='http://www.w3.org/TR/REC-html40'>
  <head><meta charset="UTF-8">
  <style>
    body { font-family: Arial, sans-serif; }
    h2 { color: #5a2d00; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 18px; }
    th { background: #ffd6a5; padding: 8px; border: 1px solid #666; font-weight: bold; text-align: center; }
    th:first-child { text-align: left; }
    td { padding: 6px; border: 1px solid #ddd; text-align: center; }
    td:first-child { text-align: left; }
    .sector-titulo-card { background: #ef6c00; color: white; padding: 8px 14px;
      font-weight: bold; font-size: 13px; display: block; }
    .celda-libre { background: #fff9c4; padding: 2px 5px; font-weight: bold; font-size: 11px; }
    .celda-nombre { color: #1b5e20; font-weight: bold; }
    .total-row td { background: #fff3e0; font-weight: bold; }
    .gran-total-row td { background: #ffd6a5; font-weight: bold; }
    .th-hoy { background: #ef6c00 !important; color: white !important; }
  </style>
  </head>
  <body>
    <h2>${titulo}</h2>
    ${contenido}
  </body></html>`;

  const blob = new Blob(["\uFEFF" + html], { type: "application/msword" });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement("a");
  a.href = url;
  a.download = `conteo_${meal}_semana_${iso(weekStart)}.doc`;
  a.click();
  URL.revokeObjectURL(url);
});
</script>

</body>
</html>
