<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#e65100">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Servicio de Comidas</title>
  <link rel="stylesheet" href="../estilo.css">
  <style>
    body { background: linear-gradient(160deg, #ffe0b2 0%, #fff8f0 50%, #fffff8 100%); }

    .srv-header {
      background: linear-gradient(135deg, #e65100, #ef6c00, #ffa726);
      border-radius: 0 0 36px 36px;
      padding: 28px 20px 22px;
      text-align: center;
      margin-bottom: 20px;
      box-shadow: 0 6px 20px rgba(230,81,0,.22);
      position: relative; overflow: hidden;
    }
    .srv-header::before {
      content:""; position:absolute; top:-30px; right:-30px;
      width:120px; height:120px; background:rgba(255,255,255,.10); border-radius:50%;
    }
    .srv-header .icon-g { font-size: 46px; display: block; margin-bottom: 6px; }
    .srv-header h1 { margin:0 0 4px; color:#fff; font-size:24px; font-weight:900; text-shadow:0 2px 6px rgba(0,0,0,.2); }
    .srv-header p  { margin:0; color:rgba(255,255,255,.9); font-size:13px; }
    .panel { padding-top: 0 !important; }

    /* Tiles de comida */
    .meal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .meal-tile {
      background: #fff; border: 2px solid #ffcc80; border-radius: 20px;
      padding: 20px 10px; text-align: center; cursor: pointer;
      box-shadow: 0 4px 12px rgba(230,81,0,.09); transition: transform .1s;
    }
    .meal-tile:active { transform: scale(0.97); }
    .meal-tile .t-icon { font-size: 38px; display: block; margin-bottom: 8px; }
    .meal-tile .t-name { font-size: 15px; font-weight: 900; color: #5a2d00; }

    /* Navegaci√≥n de fecha */
    .fecha-nav {
      display: flex; align-items: center; justify-content: space-between;
      background: #fff; border: 2px solid #ffcc80; border-radius: 14px;
      padding: 10px 12px; margin-bottom: 12px;
    }
    .fecha-nav-btn {
      background: #ffd6a5; border: none; border-radius: 10px;
      padding: 8px 16px; font-size: 18px; font-weight: 900; color: #7a4200; cursor: pointer;
    }
    .fecha-nav-btn:active { opacity: .7; }
    .fecha-label { font-size: 14px; font-weight: 800; color: #5a2d00; text-align: center; }

    /* Resumen din√°mico */
    .resumen {
      display: flex; gap: 8px; margin-bottom: 14px; flex-wrap: wrap;
    }
    .resumen-item {
      flex: 1; min-width: 70px;
      background: #fff; border-radius: 14px; padding: 10px 6px;
      text-align: center; border: 2px solid;
    }
    .resumen-num  { font-size: 22px; font-weight: 900; display: block; }
    .resumen-txt  { font-size: 10px; font-weight: 700; display: block; margin-top: 2px; opacity: .8; }
    .r-pendiente  { border-color: #bdbdbd; color: #616161; }
    .r-servido    { border-color: #a5d6a7; color: #2e7d32; }
    .r-falta-plato{ border-color: #ffcc80; color: #e65100; }
    .r-falta-sopa { border-color: #80cbc4; color: #00695c; }

    /* Sub-header */
    .sub-header {
      display: flex; align-items: center; gap: 12px; margin-bottom: 14px;
    }
    .btn-volver-sub {
      padding: 8px 14px; border: 1.5px solid #ffcc80; border-radius: 12px;
      background: #fff8ee; color: #7a4200; font-size: 13px; font-weight: 700;
      cursor: pointer; white-space: nowrap;
    }
    .sub-titulo { font-size: 20px; font-weight: 900; color: #5a2d00; }

    /* Lista de personas */
    .persona-srv {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 14px; border-bottom: 1px solid #fff3e0; gap: 10px;
    }
    .persona-srv:last-child { border-bottom: none; }
    .persona-srv-nombre { font-size: 16px; font-weight: 800; color: #333; }
    .persona-srv-sub { font-size: 12px; color: #999; margin-top: 2px; }

    /* Badge de estado */
    .estado-badge {
      display: flex; align-items: center; gap: 6px;
      padding: 8px 12px; border-radius: 12px; border: 2px solid;
      font-size: 13px; font-weight: 800; cursor: pointer;
      white-space: nowrap; flex-shrink: 0; transition: opacity .1s;
    }
    .estado-badge:active { opacity: .7; }
    .est-pendiente   { background: #f5f5f5;  border-color: #bdbdbd; color: #616161; }
    .est-servido     { background: #e8f5e9;  border-color: #a5d6a7; color: #2e7d32; }
    .est-falta-plato { background: #fff3e0;  border-color: #ffcc80; color: #e65100; }
    .est-falta-sopa  { background: #e0f2f1;  border-color: #80cbc4; color: #00695c; }

    /* Modal */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,.45);
      display: flex; align-items: flex-end; justify-content: center;
      z-index: 1000; padding: 0;
    }
    .modal-overlay.hidden { display: none !important; }
    .modal-sheet {
      background: #fff; border-radius: 24px 24px 0 0; padding: 22px 18px 32px;
      width: 100%; max-width: 480px;
      box-shadow: 0 -8px 30px rgba(0,0,0,.2);
      animation: slideUp .18s ease;
    }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .modal-nombre { font-size: 17px; font-weight: 900; color: #333; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #f0f0f0; }
    .opcion-btn {
      width: 100%; display: flex; align-items: center; gap: 14px;
      padding: 14px 16px; border: 2px solid; border-radius: 16px;
      margin-bottom: 10px; cursor: pointer; font-size: 15px; font-weight: 800;
      background: #fff; transition: opacity .1s; font-family: Arial, sans-serif;
    }
    .opcion-btn:active { opacity: .75; }
    .op-icon { font-size: 22px; flex-shrink: 0; }
    .op-pendiente   { border-color: #bdbdbd; color: #616161; }
    .op-servido     { border-color: #a5d6a7; color: #2e7d32; background: #f1fff6; }
    .op-falta-plato { border-color: #ffcc80; color: #e65100; background: #fff8f0; }
    .op-falta-sopa  { border-color: #80cbc4; color: #00695c; background: #e0f2f1; }
    .op-btn-cancelar {
      width: 100%; padding: 13px; border: 2px solid #ddd; border-radius: 14px;
      background: #f5f5f5; color: #888; font-size: 15px; font-weight: 700;
      cursor: pointer; margin-top: 12px; font-family: Arial, sans-serif;
    }

    .sin-datos { text-align: center; padding: 28px 16px; color: #aaa; font-size: 15px; }
    .hoy-tag {
      background: #ef6c00; color: #fff; font-size: 11px; font-weight: 700;
      border-radius: 6px; padding: 2px 6px; margin-left: 6px;
    }
  </style>
</head>
<body>

<main class="panel" style="padding-top:0;">

  <div class="srv-header">
    <span class="icon-g">üçΩÔ∏è</span>
    <h1>Servicio de Comidas</h1>
    <p id="fechaHoy">‚Äî</p>
  </div>

  <!-- ===== STEP 1: ELEGIR COMIDA ===== -->
  <div id="stepMeals">
    <section class="form-card" style="border-color:#ffcc80;">
      <h4 style="margin:0 0 14px; color:#7a4200;">¬øQu√© comida est√°s sirviendo?</h4>
      <div class="meal-grid">
        <div class="meal-tile" data-meal="desayuno">
          <span class="t-icon">üçû</span>
          <span class="t-name">DESAYUNO</span>
        </div>
        <div class="meal-tile" data-meal="almuerzo">
          <span class="t-icon">üçõ</span>
          <span class="t-name">ALMUERZO</span>
        </div>
        <div class="meal-tile" data-meal="merienda">
          <span class="t-icon">ü•ê</span>
          <span class="t-name">MERIENDA</span>
        </div>
        <div class="meal-tile" data-meal="cena">
          <span class="t-icon">üç≤</span>
          <span class="t-name">CENA</span>
        </div>
      </div>
    </section>
    <a class="btn-volver-bottom" href="../index.html">‚¨Ö Volver al inicio</a>
  </div>

  <!-- ===== STEP 2: LISTA DE SERVICIO ===== -->
  <div id="stepLista" class="hidden">
    <section class="form-card" style="border-color:#ffcc80;">

      <div class="sub-header">
        <button class="btn-volver-sub" id="btnVolverMeals" type="button">‚Üê Comidas</button>
        <span class="sub-titulo" id="listaTitulo"></span>
      </div>

      <div class="fecha-nav">
        <button class="fecha-nav-btn" id="btnDiaAnterior" type="button">‚óÄ</button>
        <span class="fecha-label" id="fechaNavLabel">‚Äî</span>
        <button class="fecha-nav-btn" id="btnDiaSiguiente" type="button">‚ñ∂</button>
      </div>

      <!-- Resumen din√°mico -->
      <div class="resumen" id="resumenEstados"></div>

      <!-- Buscador -->
      <input type="text" id="buscadorSrv" placeholder="üîç Buscar nombre..."
        style="width:100%;padding:11px 14px;border:2px solid #ffcc80;border-radius:12px;
               font-size:15px;background:#fff;margin-bottom:10px;display:none;"
        autocomplete="off">

      <p class="loading" id="msgLista">Cargando...</p>
      <div id="listaPersonas"></div>
    </section>

    <a class="btn-volver-bottom" href="../index.html" style="margin-top:0;">‚¨Ö Volver al inicio</a>
  </div>

</main>

<!-- ===== MODAL ===== -->
<div class="modal-overlay hidden" id="modalEstado">
  <div class="modal-sheet">
    <div class="modal-nombre" id="modalNombre">Seleccion√° estado</div>
    <div id="modalOpciones"></div>
    <button class="op-btn-cancelar" id="btnCerrarModal" type="button">Cancelar</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script src="../firebase-config.js"></script>
<script>

// ===== ESTADOS =====
const ESTADOS = {
  pendiente:   { cls: "est-pendiente",   label: "‚è≥ Pendiente",      resCls: "r-pendiente",   resTxt: "‚è≥ Pendiente" },
  servido:     { cls: "est-servido",     label: "‚úÖ Ya se sirvi√≥",   resCls: "r-servido",     resTxt: "‚úÖ Servido" },
  falta_plato: { cls: "est-falta-plato", label: "üçΩÔ∏è Falta el plato", resCls: "r-falta-plato", resTxt: "üçΩÔ∏è Falta plato" },
  falta_sopa:  { cls: "est-falta-sopa",  label: "ü•£ Falta la sopa",  resCls: "r-falta-sopa",  resTxt: "ü•£ Falta sopa" }
};

// Opciones disponibles seg√∫n comida
const OPCIONES_POR_MEAL = {
  desayuno: ["pendiente", "servido"],
  almuerzo: ["pendiente", "servido", "falta_plato", "falta_sopa"],
  merienda: ["pendiente", "servido"],
  cena:     ["pendiente", "servido"]
};

const stepMeals     = document.getElementById("stepMeals");
const stepLista     = document.getElementById("stepLista");
const listaTitulo   = document.getElementById("listaTitulo");
const listaPersonas = document.getElementById("listaPersonas");
const msgLista      = document.getElementById("msgLista");
const modalEstado   = document.getElementById("modalEstado");
const modalNombre   = document.getElementById("modalNombre");
const modalOpciones = document.getElementById("modalOpciones");

let mealActual    = null;
let fechaActual   = iso(new Date());
let personal      = {};
let personalListo = false;
let servicioData  = {};
let listaCompleta = [];
let personaModal  = null;
let listaCache    = [];

// ===== Fecha en el header =====
const hoy = new Date();
const diasNombre  = ["domingo","lunes","martes","mi√©rcoles","jueves","viernes","s√°bado"];
const mesesNombre = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
document.getElementById("fechaHoy").textContent =
  `${diasNombre[hoy.getDay()]} ${hoy.getDate()} de ${mesesNombre[hoy.getMonth()]} ${hoy.getFullYear()}`;

// ===== ELEGIR COMIDA =====
document.querySelectorAll(".meal-tile").forEach(tile => {
  tile.addEventListener("click", () => abrirServicio(tile.dataset.meal));
});

function abrirServicio(meal) {
  mealActual  = meal;
  fechaActual = iso(new Date());
  listaTitulo.textContent = `${COMIDA_ICON[meal]} ${COMIDA_LABEL[meal]}`;
  stepMeals.classList.add("hidden");
  stepLista.classList.remove("hidden");
  cargarLista();
}

document.getElementById("btnVolverMeals").addEventListener("click", () => {
  stepLista.classList.add("hidden");
  stepMeals.classList.remove("hidden");
  mealActual = null;
});

// ===== NAVEGACI√ìN DE FECHA =====
function actualizarFechaLabel() {
  const d    = new Date(fechaActual + "T00:00:00");
  const esHoy = fechaActual === iso(new Date());
  const nombre = diasNombre[d.getDay()];
  const label  = `${nombre.charAt(0).toUpperCase() + nombre.slice(1)} ${d.getDate()}/${pad(d.getMonth()+1)}`;
  document.getElementById("fechaNavLabel").innerHTML =
    label + (esHoy ? '<span class="hoy-tag">HOY</span>' : "");
}

document.getElementById("btnDiaAnterior").addEventListener("click", () => {
  fechaActual = iso(addDays(new Date(fechaActual + "T00:00:00"), -1));
  cargarLista();
});
document.getElementById("btnDiaSiguiente").addEventListener("click", () => {
  fechaActual = iso(addDays(new Date(fechaActual + "T00:00:00"), 1));
  cargarLista();
});

// ===== CARGAR DATOS =====
async function cargarLista() {
  actualizarFechaLabel();
  msgLista.textContent = "Cargando...";
  msgLista.classList.remove("hidden");
  listaPersonas.innerHTML = "";
  document.getElementById("resumenEstados").innerHTML = "";
  servicioData = {};

  const buscador = document.getElementById("buscadorSrv");
  buscador.style.display = "none";
  buscador.value = "";

  try {
    if (!personalListo) {
      personal      = (await dbGet("personal")) || {};
      personalListo = true;
    }

    const activos = Object.entries(personal).filter(([, p]) => p.activo);

    const [regsResult, srv] = await Promise.all([
      Promise.all(activos.map(([key]) =>
        dbGet(`registros/${key}/${fechaActual}/${mealActual}`)
          .catch(() => null)
          .then(val => ({ key, val }))
      )),
      dbGet(`servicio/${fechaActual}/${mealActual}`)
    ]);

    const regHoy = {};
    regsResult.forEach(({ key, val }) => { regHoy[key] = val; });
    servicioData = srv || {};

    listaCompleta = activos
      .filter(([key, p]) => {
        if (!comidasDeTurno(p.turno).includes(mealActual)) return false;
        return regHoy[key] === "SI";
      })
      .map(([key, p]) => ({ key, ...p }))
      .sort((a, b) => (a.nombre || "").localeCompare(b.nombre || "", "es"));

    msgLista.classList.add("hidden");

    if (!listaCompleta.length) {
      listaPersonas.innerHTML = `<div class="sin-datos">
        Sin registros de <strong>${COMIDA_LABEL[mealActual]}</strong> para este d√≠a.<br>
        <span style="font-size:13px;">Verific√° que el personal haya marcado SI.</span>
      </div>`;
      renderResumen([]);
      return;
    }

    buscador.style.display = "block";
    renderLista(listaCompleta);

  } catch {
    msgLista.textContent = "‚ùå Error al cargar. Verifica el WiFi.";
  }
}

// ===== BUSCADOR =====
document.getElementById("buscadorSrv").addEventListener("input", function () {
  const q = this.value.trim().toLowerCase();
  const filtrada = q
    ? listaCompleta.filter(p => primerNombre(p.nombre).toLowerCase().includes(q))
    : listaCompleta;
  renderLista(filtrada);
});

// ===== RENDER LISTA =====
function renderLista(lista) {
  listaPersonas.innerHTML = lista.map(p => {
    const estado = servicioData[p.key] || "pendiente";
    const est    = ESTADOS[estado] || ESTADOS.pendiente;
    return `<div class="persona-srv" data-key="${p.key}">
      <div>
        <div class="persona-srv-nombre">${primerNombre(p.nombre)}</div>
        <div class="persona-srv-sub">${labelSector(p)} ¬∑ ${labelTurno(p)}</div>
      </div>
      <button class="estado-badge ${est.cls}" data-key="${p.key}" type="button">
        ${est.label}
      </button>
    </div>`;
  }).join("");

  listaPersonas.querySelectorAll(".estado-badge").forEach(btn => {
    btn.addEventListener("click", () => abrirModal(btn.dataset.key, lista));
  });

  renderResumen(lista);
}

// ===== RESUMEN DIN√ÅMICO =====
function renderResumen(lista) {
  const opciones = OPCIONES_POR_MEAL[mealActual] || ["pendiente","servido"];
  const conteo   = {};
  opciones.forEach(o => { conteo[o] = 0; });
  lista.forEach(p => {
    const e = servicioData[p.key] || "pendiente";
    if (conteo[e] !== undefined) conteo[e]++;
  });

  document.getElementById("resumenEstados").innerHTML = opciones.map(o => {
    const est = ESTADOS[o];
    return `<div class="resumen-item ${est.resCls}">
      <span class="resumen-num">${conteo[o]}</span>
      <span class="resumen-txt">${est.resTxt}</span>
    </div>`;
  }).join("");
}

// ===== MODAL =====
function abrirModal(key, lista) {
  personaModal = key;
  listaCache   = lista;
  const p = lista.find(x => x.key === key);
  modalNombre.textContent = `üë§ ${p?.nombre || key}`;

  const opciones = OPCIONES_POR_MEAL[mealActual] || ["pendiente","servido"];
  modalOpciones.innerHTML = opciones.map(o => {
    const est = ESTADOS[o];
    return `<button class="opcion-btn op-${o.replace("_","-")}" data-estado="${o}" type="button">
      <span class="op-icon">${est.label.split(" ")[0]}</span>
      ${est.label.substring(est.label.indexOf(" ")+1)}
    </button>`;
  }).join("");

  modalOpciones.querySelectorAll(".opcion-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      cambiarEstado(personaModal, btn.dataset.estado);
      cerrarModal();
    });
  });

  modalEstado.classList.remove("hidden");
}

function cerrarModal() {
  modalEstado.classList.add("hidden");
  personaModal = null;
}

modalEstado.addEventListener("click", e => {
  if (e.target === modalEstado) cerrarModal();
});
document.getElementById("btnCerrarModal").addEventListener("click", cerrarModal);

// ===== CAMBIAR ESTADO =====
async function cambiarEstado(key, nuevoEstado) {
  servicioData[key] = nuevoEstado;

  const badge = listaPersonas.querySelector(`.estado-badge[data-key="${key}"]`);
  if (badge) {
    const est = ESTADOS[nuevoEstado] || ESTADOS.pendiente;
    badge.className  = `estado-badge ${est.cls}`;
    badge.textContent = est.label;
  }

  renderResumen(listaCache);

  try {
    await dbSet(`servicio/${fechaActual}/${mealActual}/${key}`, nuevoEstado);
  } catch {
    servicioData[key] = "pendiente";
    if (badge) {
      badge.className   = `estado-badge ${ESTADOS.pendiente.cls}`;
      badge.textContent = ESTADOS.pendiente.label;
    }
    renderResumen(listaCache);
    alert("‚ùå Error al guardar. Verifica el WiFi.");
  }
}

// ===== REINICIAR AL VOLVER A LA APP =====
document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "visible") {
    personalListo = false;
    if (mealActual) cargarLista();
  }
});

</script>
</body>
</html>
