<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#7c3aed">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Sistema de Comidas</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: Arial, sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: #f5f0ff;
    }

    /* ‚îÄ‚îÄ 2 botones que ocupan toda la pantalla ‚îÄ‚îÄ */
    .home-grid {
      flex: 1;
      display: grid;
      grid-template-rows: 1fr 1fr;
    }
    .home-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 14px;
      text-decoration: none;
      transition: filter .1s;
    }
    .home-btn:active { filter: brightness(.93); }
    .home-btn .hb-icon { font-size: 64px; line-height: 1; }
    .home-btn .hb-label {
      font-size: 22px;
      font-weight: 900;
      letter-spacing: .3px;
    }
    .home-btn .hb-sub {
      font-size: 13px;
      font-weight: 400;
      opacity: .65;
      margin-top: -6px;
    }

    /* Colores de los 2 botones */
    .btn-registro {
      background: #b5ead7;
      color: #1a5c40;
      border-bottom: 3px solid #8dd4b8;
    }
    .btn-servicio {
      background: #ffd6a5;
      color: #7a3900;
    }

    /* ‚îÄ‚îÄ Modal PIN ‚îÄ‚îÄ */
    .modal-overlay {
      display: none;
      position: fixed; inset: 0;
      background: rgba(0,0,0,.55);
      z-index: 999;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .modal-overlay.activo { display: flex; }
    .modal-box {
      background: #fff;
      border-radius: 26px;
      padding: 28px 24px 20px;
      width: min(320px, 100%);
      box-shadow: 0 16px 48px rgba(0,0,0,.28);
      animation: up .18s ease;
      text-align: center;
    }
    @keyframes up { from { opacity:0; transform:translateY(14px); } to { opacity:1; transform:none; } }

    .modal-titulo {
      font-size: 18px;
      font-weight: 900;
      color: #4a2080;
      margin-bottom: 6px;
    }
    .modal-sub {
      font-size: 12px;
      color: #aaa;
      margin-bottom: 20px;
    }

    /* Indicadores del PIN */
    .pin-dots {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-bottom: 22px;
    }
    .pin-dot {
      width: 18px; height: 18px;
      border-radius: 50%;
      border: 2px solid #c9a8f0;
      background: #fff;
      transition: background .1s, border-color .1s;
    }
    .pin-dot.lleno {
      background: #7c3aed;
      border-color: #7c3aed;
    }
    .pin-dot.error {
      background: #e57373;
      border-color: #e57373;
    }

    /* Teclado num√©rico */
    .pin-pad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 14px;
    }
    .pin-key {
      padding: 14px 0;
      font-size: 20px;
      font-weight: 700;
      border: 2px solid #e8d5ff;
      border-radius: 14px;
      background: #faf7ff;
      color: #4a2080;
      cursor: pointer;
      transition: background .08s;
      font-family: Arial, sans-serif;
    }
    .pin-key:active { background: #e8d5ff; }
    .pin-key.key-del { font-size: 18px; color: #888; border-color: #eee; background: #f5f5f5; }
    .pin-key.key-ok  {
      background: #7c3aed; color: #fff;
      border-color: #7c3aed; font-size: 18px;
    }
    .pin-key.key-ok:active { background: #5b21b6; }

    .pin-msg {
      font-size: 13px;
      color: #e53935;
      min-height: 18px;
      margin-bottom: 10px;
    }
    .btn-cancelar {
      width: 100%; padding: 10px;
      border: 1.5px solid #ddd; border-radius: 12px;
      background: #f5f5f5; font-size: 13px;
      cursor: pointer; font-family: Arial, sans-serif;
    }
    .btn-cancelar:active { opacity: .8; }
  </style>
</head>
<body>

  <!-- ‚îÄ‚îÄ PANTALLA P√öBLICA: 2 botones que llenan la pantalla ‚îÄ‚îÄ -->
  <div class="home-grid">

    <a href="PAGES/registro.html" class="home-btn btn-registro">
      <span class="hb-icon">üìù</span>
      <span class="hb-label">Registrar comidas</span>
      <span class="hb-sub">Seleccion√° tu nombre y marc√°</span>
    </a>

    <a href="PAGES/servicio.html" class="home-btn btn-servicio">
      <span class="hb-icon">üçΩÔ∏è</span>
      <span class="hb-label">Ir a Servicio</span>
      <span class="hb-sub">Marcar platos entregados</span>
    </a>

  </div>

  <!-- ‚îÄ‚îÄ ZONAS INVISIBLES ‚îÄ‚îÄ -->
  <!-- 3 toques esquina inferior izquierda -->
  <div id="zonaTrigger"
       style="position:fixed;bottom:0;left:0;width:72px;height:72px;z-index:500;"></div>

  <!-- ‚îÄ‚îÄ MODAL PIN ‚îÄ‚îÄ -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal-box">
      <div class="modal-titulo">üîë Acceso</div>
      <div class="modal-sub">Ingres√° tu PIN de 4 d√≠gitos</div>

      <div class="pin-dots">
        <div class="pin-dot" id="d0"></div>
        <div class="pin-dot" id="d1"></div>
        <div class="pin-dot" id="d2"></div>
        <div class="pin-dot" id="d3"></div>
      </div>

      <div class="pin-pad">
        <button class="pin-key" onclick="tecla('1')">1</button>
        <button class="pin-key" onclick="tecla('2')">2</button>
        <button class="pin-key" onclick="tecla('3')">3</button>
        <button class="pin-key" onclick="tecla('4')">4</button>
        <button class="pin-key" onclick="tecla('5')">5</button>
        <button class="pin-key" onclick="tecla('6')">6</button>
        <button class="pin-key" onclick="tecla('7')">7</button>
        <button class="pin-key" onclick="tecla('8')">8</button>
        <button class="pin-key" onclick="tecla('9')">9</button>
        <button class="pin-key key-del" onclick="borrar()">‚å´</button>
        <button class="pin-key" onclick="tecla('0')">0</button>
        <button class="pin-key key-ok" id="keyOk" onclick="verificar()">‚Üí</button>
      </div>

      <div class="pin-msg" id="pinMsg"></div>
      <button class="btn-cancelar" onclick="cerrarModal()">Cancelar</button>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script>
    let pin = "";

    // ‚îÄ‚îÄ Actualizar puntos visuales ‚îÄ‚îÄ
    function actualizarDots(error = false) {
      for (let i = 0; i < 4; i++) {
        const d = document.getElementById("d" + i);
        d.className = "pin-dot";
        if (error) d.classList.add("error");
        else if (i < pin.length) d.classList.add("lleno");
      }
    }

    function tecla(n) {
      if (pin.length >= 4) return;
      pin += n;
      actualizarDots();
      document.getElementById("pinMsg").textContent = "";
      if (pin.length === 4) verificar();
    }

    function borrar() {
      pin = pin.slice(0, -1);
      actualizarDots();
      document.getElementById("pinMsg").textContent = "";
    }

    // ‚îÄ‚îÄ TRIGGER: 3 toques esquina inferior izquierda ‚îÄ‚îÄ
    let cornerTaps = 0, cornerTimer = null;
    document.getElementById("zonaTrigger").addEventListener("click", () => {
      cornerTaps++;
      clearTimeout(cornerTimer);
      cornerTimer = setTimeout(() => { cornerTaps = 0; }, 2000);
      if (cornerTaps >= 3) {
        cornerTaps = 0;
        clearTimeout(cornerTimer);
        abrirModal();
      }
    });

    // ‚îÄ‚îÄ TRIGGER: deslizar desde borde derecho ‚îÄ‚îÄ
    let swipeStartX = 0;
    document.addEventListener("touchstart", e => {
      swipeStartX = e.touches[0].clientX >= window.innerWidth - 30
        ? e.touches[0].clientX : 0;
    }, { passive: true });
    document.addEventListener("touchend", e => {
      if (!swipeStartX) return;
      const dx = swipeStartX - e.changedTouches[0].clientX;
      swipeStartX = 0;
      if (dx > 60) abrirModal();
    }, { passive: true });

    // ‚îÄ‚îÄ Modal ‚îÄ‚îÄ
    function abrirModal() {
      pin = "";
      actualizarDots();
      document.getElementById("pinMsg").textContent = "";
      document.getElementById("modalOverlay").classList.add("activo");
    }
    function cerrarModal() {
      document.getElementById("modalOverlay").classList.remove("activo");
      pin = "";
      actualizarDots();
    }
    document.getElementById("modalOverlay").addEventListener("click", e => {
      if (e.target === document.getElementById("modalOverlay")) cerrarModal();
    });

    // ‚îÄ‚îÄ Verificar PIN contra Firebase ‚îÄ‚îÄ
    async function verificar() {
      if (pin.length < 4) return;
      document.getElementById("pinMsg").textContent = "Verificando...";

      try {
        let admins = await dbGet("config/admins");
        if (!admins) {
          const dp = (await dbGet("config/admin_pass")) || "1234";
          await dbSet("config/admins/0000", { nombre: "Admin", password: dp, rol: "admin" });
          admins = { "0000": { nombre: "Admin", password: dp, rol: "admin" } };
        }

        // Buscar cualquier admin cuya contrase√±a coincida con el PIN
        let encontrado = null;
        for (const [, admin] of Object.entries(admins)) {
          if (admin.password === pin) { encontrado = admin; break; }
        }

        if (encontrado) {
          sessionStorage.setItem("rol_activo", encontrado.rol || "admin");
          sessionStorage.setItem("rol_nombre", encontrado.nombre || "");
          cerrarModal();
          if ((encontrado.rol || "admin") === "supervisor") {
            window.location.href = "PAGES/panel_supervisor.html";
          } else {
            window.location.href = "PAGES/panel_admin.html";
          }
        } else {
          actualizarDots(true);
          document.getElementById("pinMsg").textContent = "PIN incorrecto";
          setTimeout(() => { pin = ""; actualizarDots(); document.getElementById("pinMsg").textContent = ""; }, 1000);
        }
      } catch(e) {
        document.getElementById("pinMsg").textContent = "Sin conexi√≥n";
        setTimeout(() => { pin = ""; actualizarDots(); document.getElementById("pinMsg").textContent = ""; }, 1500);
      }
    }
  </script>

  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("/sw.js").catch(e => console.warn(e));
      });
    }
  </script>
</body>
</html>
