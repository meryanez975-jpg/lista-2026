<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#7c3aed">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Sistema de Comidas</title>
  <link rel="stylesheet" href="estilo.css" />
  <style>
    body {
      background: linear-gradient(160deg, #e8d5ff 0%, #d4f0e8 50%, #ffd6a5 100%);
      min-height: 100vh;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
    }
    .top-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      background: rgba(255,255,255,.50);
      border-bottom: 2px solid rgba(255,255,255,.65);
    }
    .top-icon { font-size: 28px; line-height: 1; padding: 4px; }
    .top-bar-titulo {
      flex: 1;
      font-size: 15px;
      font-weight: 800;
      color: #4a2080;
    }
    .top-bar-titulo .tb-sub { font-size: 11px; color: #888; font-weight: 400; margin-top: 1px; }
    .panel-body {
      flex: 1;
      padding: 20px 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-width: 440px;
      width: 100%;
      margin: 0 auto;
    }
    .panel-btn {
      display: flex; align-items: center; gap: 14px;
      padding: 18px 20px; text-decoration: none;
      border-radius: 20px; border: 2.5px solid transparent;
      font-size: 16px; font-weight: 800;
      box-shadow: 0 4px 14px rgba(0,0,0,.09);
      transition: transform .1s, box-shadow .1s;
      font-family: Arial, sans-serif; color: inherit;
    }
    .panel-btn:active { transform: scale(0.97); box-shadow: 0 2px 7px rgba(0,0,0,.09); }
    .panel-btn .pb-icon { font-size: 30px; line-height: 1; }
    .panel-btn .pb-sub { font-size: 12px; font-weight: 400; opacity: .7; margin-top: 2px; }
    .pb-registro { background: #b5ead7; color: #1a5c40; border-color: #8dd4b8; }
    .pb-servicio { background: #ffe0b2; color: #7a3900; border-color: #ffb74d; }

    /* Modal */
    .modal-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,.50); z-index: 999;
      justify-content: center; align-items: center; padding: 20px;
    }
    .modal-overlay.activo { display: flex; }
    .modal-box {
      background: #fff; border-radius: 24px; padding: 28px 24px;
      width: min(360px, 100%); box-shadow: 0 14px 44px rgba(0,0,0,.28);
      animation: fadeIn .18s ease;
    }
    @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:none; } }
    .modal-box h3 { margin: 0 0 6px; text-align: center; font-size: 19px; font-weight: 900; color: #4a2080; font-family: Arial, sans-serif; }
    .modal-box .modal-sub { text-align: center; font-size: 13px; color: #888; margin: 0 0 22px; }
    .btn-cancelar-modal {
      width: 100%; padding: 10px; margin-top: 8px;
      border: 1.5px solid #ddd; border-radius: 12px;
      background: #f5f5f5; font-size: 13px; cursor: pointer; font-family: Arial, sans-serif;
    }
  </style>
</head>
<body>

  <div class="top-bar">
    <span class="top-icon">üçΩÔ∏è</span>
    <div class="top-bar-titulo">
      Sistema de Comidas
      <div class="tb-sub">Acceso p√∫blico</div>
    </div>
  </div>

  <div class="panel-body">
    <a href="PAGES/registro.html" class="panel-btn pb-registro">
      <span class="pb-icon">üìù</span>
      <div>
        <div>Registrar comidas</div>
        <div class="pb-sub">Seleccion√° tu nombre y marc√°</div>
      </div>
    </a>
    <a href="PAGES/servicio.html" class="panel-btn pb-servicio">
      <span class="pb-icon">üçΩÔ∏è</span>
      <div>
        <div>Ir a Servicio</div>
        <div class="pb-sub">Marcar platos entregados</div>
      </div>
    </a>
  </div>

  <!-- Zona invisible: esquina inferior izquierda (supervisor) -->
  <div id="zonaSupervisor"
       style="position:fixed;bottom:0;left:0;width:72px;height:72px;z-index:500;"></div>

  <!-- Modal de acceso -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal-box">
      <h3>üîë Acceso</h3>
      <p class="modal-sub">Ingres√° tus datos para continuar</p>
      <div class="form-card" style="margin:0;border:none;background:transparent;box-shadow:none;padding:0;">
        <label class="campo">
          <span>N√∫mero de celular</span>
          <input type="tel" id="mPhone" inputmode="numeric" placeholder="Ej: 099123456">
        </label>
        <label class="campo">
          <span>Contrase√±a</span>
          <input type="password" id="mPass" placeholder="Contrase√±a">
        </label>
        <button class="btn-primario" id="mBtnEntrar" type="button">Entrar</button>
        <p class="nota" id="mMsg"></p>
      </div>
      <button class="btn-cancelar-modal" id="mBtnCerrar" type="button">Cancelar</button>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script>
    const modalOverlay = document.getElementById("modalOverlay");
    const mPhone       = document.getElementById("mPhone");
    const mPass        = document.getElementById("mPass");
    const mBtnEntrar   = document.getElementById("mBtnEntrar");
    const mBtnCerrar   = document.getElementById("mBtnCerrar");
    const mMsg         = document.getElementById("mMsg");

    // ‚îÄ‚îÄ TRIGGER 1: 3 toques esquina inferior izquierda ‚Üí supervisor ‚îÄ‚îÄ
    let cornerTaps = 0, cornerTimer = null;
    document.getElementById("zonaSupervisor").addEventListener("click", () => {
      cornerTaps++;
      clearTimeout(cornerTimer);
      cornerTimer = setTimeout(() => { cornerTaps = 0; }, 2000);
      if (cornerTaps >= 3) {
        cornerTaps = 0;
        clearTimeout(cornerTimer);
        abrirModal();
      }
    });

    // ‚îÄ‚îÄ TRIGGER 2: deslizar desde borde derecho ‚Üí admin ‚îÄ‚îÄ
    let swipeStartX = 0;
    document.addEventListener("touchstart", e => {
      swipeStartX = e.touches[0].clientX >= window.innerWidth - 30
        ? e.touches[0].clientX : 0;
    }, { passive: true });
    document.addEventListener("touchend", e => {
      if (!swipeStartX) return;
      const dx = swipeStartX - e.changedTouches[0].clientX;
      swipeStartX = 0;
      if (dx > 60) abrirModal();
    }, { passive: true });

    // ‚îÄ‚îÄ Modal ‚îÄ‚îÄ
    function abrirModal() {
      mPhone.value = ""; mPass.value = ""; mMsg.textContent = "";
      modalOverlay.classList.add("activo");
      mPhone.focus();
    }
    function cerrarModal() {
      modalOverlay.classList.remove("activo");
      mPhone.value = ""; mPass.value = ""; mMsg.textContent = "";
    }
    mBtnCerrar.addEventListener("click", cerrarModal);
    modalOverlay.addEventListener("click", e => { if (e.target === modalOverlay) cerrarModal(); });

    // ‚îÄ‚îÄ Login ‚Üí redirige a la p√°gina del rol ‚îÄ‚îÄ
    mBtnEntrar.addEventListener("click", async () => {
      const phone = mPhone.value.trim();
      const pass  = mPass.value.trim();
      if (!phone || !pass) { mMsg.textContent = "Ingres√° celular y contrase√±a."; return; }

      mBtnEntrar.disabled = true;
      mBtnEntrar.textContent = "Verificando...";
      mMsg.textContent = "";

      try {
        let admins = await dbGet("config/admins");
        if (!admins) {
          const dp = (await dbGet("config/admin_pass")) || "1234";
          await dbSet("config/admins/0000", { nombre: "Admin", password: dp, rol: "admin" });
          admins = { "0000": { nombre: "Admin", password: dp, rol: "admin" } };
        }
        const admin = admins[phone];
        if (admin && admin.password === pass) {
          const rol    = admin.rol || "admin";
          const nombre = admin.nombre || "Administrador";
          sessionStorage.setItem("rol_activo",    rol);
          sessionStorage.setItem("rol_nombre",    nombre);
          sessionStorage.setItem("rol_phone",     phone);
          cerrarModal();
          if (rol === "supervisor") {
            window.location.href = "PAGES/panel_supervisor.html";
          } else {
            window.location.href = "PAGES/panel_admin.html";
          }
        } else {
          mMsg.textContent = "‚ùå N√∫mero o contrase√±a incorrectos.";
          mPass.value = ""; mPass.focus();
        }
      } catch(e) {
        mMsg.textContent = "‚ùå Sin conexi√≥n. Verific√° el WiFi.";
      }

      mBtnEntrar.disabled = false;
      mBtnEntrar.textContent = "Entrar";
    });

    [mPhone, mPass].forEach(el =>
      el.addEventListener("keydown", e => { if (e.key === "Enter") mBtnEntrar.click(); })
    );
  </script>

  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("/sw.js").catch(e => console.warn("SW error:", e));
      });
    }
  </script>
</body>
</html>
