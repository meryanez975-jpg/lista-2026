<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- PWA -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#7c3aed">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Sistema de Comidas</title>
  <link rel="stylesheet" href="estilo.css" />
  <style>
    body {
      background: linear-gradient(160deg, #e8d5ff 0%, #d4f0e8 50%, #ffd6a5 100%);
      min-height: 100vh;
      font-family: Arial, sans-serif;
    }

    /* ===== PANTALLAS ===== */
    .screen { display: none; min-height: 100vh; flex-direction: column; }
    .screen.activa { display: flex; }

    /* ===== SELECTOR (pantalla 1) ===== */
    .selector-wrap {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 32px 24px;
      text-align: center;
    }
    .selector-icon { font-size: 72px; margin-bottom: 12px; }
    .selector-titulo {
      font-size: 24px;
      font-weight: 900;
      color: #4a2080;
      margin-bottom: 6px;
      letter-spacing: .5px;
    }
    .selector-sub {
      font-size: 13px;
      color: #888;
      margin-bottom: 36px;
    }
    .selector-cards { width: 100%; max-width: 340px; display: flex; flex-direction: column; gap: 14px; }

    .rol-card {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 20px 22px;
      border-radius: 22px;
      border: 2.5px solid transparent;
      font-size: 18px;
      font-weight: 900;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(0,0,0,.10);
      transition: transform .1s, box-shadow .1s;
      text-align: left;
      font-family: Arial, sans-serif;
      background: none;
      width: 100%;
    }
    .rol-card:active { transform: scale(0.97); box-shadow: 0 3px 10px rgba(0,0,0,.10); }
    .rol-card .rc-icon { font-size: 36px; line-height: 1; }
    .rol-card .rc-sub { font-size: 12px; font-weight: 400; opacity: .7; margin-top: 3px; }

    .card-publico  { background: #b5ead7; color: #1a5c40; border-color: #8dd4b8; }
    .card-super    { background: #c7dcff; color: #1a3080; border-color: #90b4f8; }
    .card-admin    { background: #e8d5ff; color: #4a2080; border-color: #c9a8f0; }

    /* ===== PANTALLAS INTERNAS (2, 3, 4) ===== */
    .panel-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 14px 16px;
      background: rgba(255,255,255,.55);
      border-bottom: 2px solid rgba(255,255,255,.7);
      backdrop-filter: blur(4px);
    }
    .btn-volver {
      width: 40px; height: 40px;
      border: 2px solid #c9a8f0;
      background: #fff;
      color: #4a2080;
      font-size: 18px;
      border-radius: 12px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-family: Arial, sans-serif;
      flex-shrink: 0;
    }
    .btn-volver:active { background: #f0e6ff; }
    .panel-header-titulo {
      flex: 1;
      font-size: 15px;
      font-weight: 800;
      color: #4a2080;
    }
    .panel-header-titulo .ph-sub {
      font-size: 11px;
      color: #888;
      font-weight: 400;
      margin-top: 1px;
    }
    .btn-salir-panel {
      padding: 6px 14px;
      border: 1.5px solid #e57373;
      border-radius: 10px;
      background: #ffebee;
      color: #c62828;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      font-family: Arial, sans-serif;
      white-space: nowrap;
    }
    .btn-salir-panel:active { opacity: .8; }

    .panel-body {
      flex: 1;
      padding: 20px 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-width: 440px;
      width: 100%;
      margin: 0 auto;
    }

    .panel-section-label {
      font-size: 11px;
      font-weight: 800;
      letter-spacing: 1.5px;
      color: #aaa;
      text-transform: uppercase;
      padding: 4px 2px 0;
    }

    /* Botones del panel */
    .panel-btn {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 18px 20px;
      text-decoration: none;
      border-radius: 20px;
      border: 2.5px solid transparent;
      font-size: 16px;
      font-weight: 800;
      box-shadow: 0 4px 14px rgba(0,0,0,.09);
      transition: transform .1s, box-shadow .1s;
      font-family: Arial, sans-serif;
      color: inherit;
    }
    .panel-btn:active { transform: scale(0.97); box-shadow: 0 2px 7px rgba(0,0,0,.09); }
    .panel-btn .pb-icon { font-size: 30px; line-height: 1; }
    .panel-btn .pb-sub { font-size: 12px; font-weight: 400; opacity: .7; margin-top: 2px; }

    .pb-registro  { background: #b5ead7; color: #1a5c40; border-color: #8dd4b8; }
    .pb-servicio  { background: #ffe0b2; color: #7a3900; border-color: #ffb74d; }
    .pb-personal  { background: #ffd6e7; color: #5c0030; border-color: #f0a8c4; }
    .pb-conteo    { background: #e3f2fd; color: #0d47a1; border-color: #90caf9; }
    .pb-menu      { background: #ffd6a5; color: #7a4200; border-color: #f5b86a; }
    .pb-lista     { background: #fce4ec; color: #880e4f; border-color: #f48fb1; }
    .pb-admin     { background: #e8d5ff; color: #4a2080; border-color: #c9a8f0; }

    /* ===== MODAL DE LOGIN ===== */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.5);
      z-index: 999;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .modal-overlay.activo { display: flex; }
    .modal-box {
      background: #fff;
      border-radius: 24px;
      padding: 28px 24px;
      width: min(380px, 100%);
      box-shadow: 0 14px 44px rgba(0,0,0,.28);
    }
    .modal-box h3 {
      margin: 0 0 6px;
      text-align: center;
      font-size: 20px;
      font-weight: 900;
      color: #4a2080;
      font-family: Arial, sans-serif;
    }
    .modal-box .modal-sub {
      text-align: center;
      font-size: 13px;
      color: #888;
      margin: 0 0 22px;
    }
    @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform:none; } }
    .modal-box { animation: fadeIn .18s ease; }
  </style>
</head>
<body>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       PANTALLA 1 ‚Äî SELECTOR DE ROL
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="screen activa" id="screenSelector">
    <div class="selector-wrap">
      <div class="selector-icon">üçΩÔ∏è</div>
      <h1 class="selector-titulo">Sistema de Comidas</h1>
      <p class="selector-sub">¬øC√≥mo quer√©s entrar?</p>

      <div class="selector-cards">

        <button class="rol-card card-publico" onclick="irPublico()">
          <span class="rc-icon">üåê</span>
          <div>
            <div>P√∫blico</div>
            <div class="rc-sub">Registrar comidas ¬∑ Ir a Servicio</div>
          </div>
        </button>

        <button class="rol-card card-super" onclick="pedirAcceso('supervisor')">
          <span class="rc-icon">üëÅÔ∏è</span>
          <div>
            <div>Supervisor</div>
            <div class="rc-sub">Gestionar personal y men√∫</div>
          </div>
        </button>

        <button class="rol-card card-admin" onclick="pedirAcceso('admin')">
          <span class="rc-icon">üîê</span>
          <div>
            <div>Administrador</div>
            <div class="rc-sub">Acceso completo al sistema</div>
          </div>
        </button>

      </div>
    </div>
  </div>


  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       PANTALLA 2 ‚Äî P√öBLICO
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="screen" id="screenPublico">
    <div class="panel-header">
      <button class="btn-volver" onclick="volverSelector()">‚Üê</button>
      <div class="panel-header-titulo">
        üåê Acceso P√∫blico
        <div class="ph-sub">Sin contrase√±a</div>
      </div>
    </div>
    <div class="panel-body">

      <a href="PAGES/registro.html" class="panel-btn pb-registro">
        <span class="pb-icon">üìù</span>
        <div>
          <div>Registrar comidas</div>
          <div class="pb-sub">Seleccion√° tu nombre y marc√°</div>
        </div>
      </a>

      <a href="PAGES/servicio.html" class="panel-btn pb-servicio">
        <span class="pb-icon">üçΩÔ∏è</span>
        <div>
          <div>Ir a Servicio</div>
          <div class="pb-sub">Marcar platos entregados</div>
        </div>
      </a>

    </div>
  </div>


  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       PANTALLA 3 ‚Äî SUPERVISOR
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="screen" id="screenSupervisor">
    <div class="panel-header">
      <button class="btn-volver" onclick="salirYVolver()">‚Üê</button>
      <div class="panel-header-titulo">
        üëÅÔ∏è Supervisor
        <div class="ph-sub" id="superNombreHeader"></div>
      </div>
      <button class="btn-salir-panel" onclick="salirYVolver()">Salir</button>
    </div>
    <div class="panel-body">

      <a href="PAGES/personal.html" class="panel-btn pb-personal">
        <span class="pb-icon">üë§</span>
        <div>
          <div>Agregar personal</div>
          <div class="pb-sub">Registrar nuevo empleado</div>
        </div>
      </a>

      <a href="PAGES/conteo.html" class="panel-btn pb-conteo">
        <span class="pb-icon">üìã</span>
        <div>
          <div>Ver registrados</div>
          <div class="pb-sub">Lista de quienes marcaron</div>
        </div>
      </a>

      <a href="PAGES/menu_admin.html" class="panel-btn pb-menu">
        <span class="pb-icon">üç≤</span>
        <div>
          <div>Editar comidas</div>
          <div class="pb-sub">Cargar men√∫ del d√≠a</div>
        </div>
      </a>

    </div>
  </div>


  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       PANTALLA 4 ‚Äî ADMIN
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="screen" id="screenAdmin">
    <div class="panel-header">
      <button class="btn-volver" onclick="salirYVolver()">‚Üê</button>
      <div class="panel-header-titulo">
        üîê Administrador
        <div class="ph-sub" id="adminNombreHeader"></div>
      </div>
      <button class="btn-salir-panel" onclick="salirYVolver()">Salir</button>
    </div>
    <div class="panel-body">

      <div class="panel-section-label">Acceso p√∫blico</div>

      <a href="PAGES/registro.html" class="panel-btn pb-registro">
        <span class="pb-icon">üìù</span>
        <div>
          <div>Registrar comidas</div>
          <div class="pb-sub">Seleccion√° nombre y marc√°</div>
        </div>
      </a>

      <a href="PAGES/servicio.html" class="panel-btn pb-servicio">
        <span class="pb-icon">üçΩÔ∏è</span>
        <div>
          <div>Ir a Servicio</div>
          <div class="pb-sub">Marcar platos entregados</div>
        </div>
      </a>

      <div class="panel-section-label">Supervisor</div>

      <a href="PAGES/personal.html" class="panel-btn pb-personal">
        <span class="pb-icon">üë§</span>
        <div>
          <div>Agregar personal</div>
          <div class="pb-sub">Registrar nuevo empleado</div>
        </div>
      </a>

      <a href="PAGES/conteo.html" class="panel-btn pb-conteo">
        <span class="pb-icon">üìã</span>
        <div>
          <div>Ver registrados</div>
          <div class="pb-sub">Lista de quienes marcaron</div>
        </div>
      </a>

      <a href="PAGES/menu_admin.html" class="panel-btn pb-menu">
        <span class="pb-icon">üç≤</span>
        <div>
          <div>Editar comidas</div>
          <div class="pb-sub">Cargar men√∫ del d√≠a</div>
        </div>
      </a>

      <div class="panel-section-label">Administraci√≥n</div>

      <a href="PAGES/lista_personal.html" class="panel-btn pb-lista">
        <span class="pb-icon">üë•</span>
        <div>
          <div>Lista del personal</div>
          <div class="pb-sub">Ver empleados por sector</div>
        </div>
      </a>

      <a href="PAGES/admin.html" class="panel-btn pb-admin">
        <span class="pb-icon">‚öôÔ∏è</span>
        <div>
          <div>Panel admin</div>
          <div class="pb-sub">Admins, datos y ajustes</div>
        </div>
      </a>

    </div>
  </div>


  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       MODAL DE CONTRASE√ëA
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal-box">
      <h3 id="mTitulo">üîê Acceso</h3>
      <p class="modal-sub" id="mSub">Ingres√° tus datos para continuar</p>
      <div class="form-card" style="margin:0; border:none; background:transparent; box-shadow:none; padding:0;">
        <label class="campo">
          <span>N√∫mero de celular</span>
          <input type="tel" id="mPhone" inputmode="numeric" placeholder="Ej: 099123456">
        </label>
        <label class="campo">
          <span>Contrase√±a</span>
          <input type="password" id="mPass" placeholder="Contrase√±a">
        </label>
        <button class="btn-primario" id="mBtnEntrar" type="button">Entrar</button>
        <p class="nota" id="mMsg"></p>
      </div>
      <button id="mBtnCerrar" type="button"
              style="margin-top:14px; width:100%; padding:10px; border:1.5px solid #ddd;
                     border-radius:12px; background:#f5f5f5; font-size:14px; cursor:pointer; font-family:Arial,sans-serif;">
        Cancelar
      </button>
    </div>
  </div>


  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script>
    // ‚îÄ‚îÄ Referencias ‚îÄ‚îÄ
    const modalOverlay = document.getElementById("modalOverlay");
    const mPhone       = document.getElementById("mPhone");
    const mPass        = document.getElementById("mPass");
    const mBtnEntrar   = document.getElementById("mBtnEntrar");
    const mBtnCerrar   = document.getElementById("mBtnCerrar");
    const mMsg         = document.getElementById("mMsg");
    const mTitulo      = document.getElementById("mTitulo");
    const mSub         = document.getElementById("mSub");

    let rolPendiente = ""; // "supervisor" o "admin"

    // ‚îÄ‚îÄ Al cargar: si hab√≠a sesi√≥n activa, retomar pantalla ‚îÄ‚îÄ
    (function retomar() {
      const logged = sessionStorage.getItem("admin_logged");
      if (logged !== "1") return;
      const rol    = sessionStorage.getItem("admin_rol") || "admin";
      const nombre = sessionStorage.getItem("admin_nombre") || "";
      if (rol === "supervisor") mostrarPantallaSuper(nombre);
      else mostrarPantallaAdmin(nombre);
    })();

    // ‚îÄ‚îÄ NAVEGAR A PANTALLAS ‚îÄ‚îÄ
    function mostrarSolo(id) {
      document.querySelectorAll(".screen").forEach(s => s.classList.remove("activa"));
      document.getElementById(id).classList.add("activa");
      window.scrollTo(0, 0);
    }

    function irPublico() {
      mostrarSolo("screenPublico");
    }

    function mostrarPantallaSuper(nombre) {
      document.getElementById("superNombreHeader").textContent = nombre;
      mostrarSolo("screenSupervisor");
    }

    function mostrarPantallaAdmin(nombre) {
      document.getElementById("adminNombreHeader").textContent = nombre;
      mostrarSolo("screenAdmin");
    }

    function volverSelector() {
      mostrarSolo("screenSelector");
    }

    function salirYVolver() {
      sessionStorage.removeItem("admin_logged");
      sessionStorage.removeItem("admin_phone");
      sessionStorage.removeItem("admin_nombre");
      sessionStorage.removeItem("admin_rol");
      volverSelector();
    }

    // ‚îÄ‚îÄ PEDIR ACCESO (abre modal) ‚îÄ‚îÄ
    function pedirAcceso(rol) {
      rolPendiente = rol;
      mTitulo.textContent = rol === "supervisor" ? "üëÅÔ∏è Supervisor" : "üîê Administrador";
      mSub.textContent    = "Ingres√° tu celular y contrase√±a";
      mPhone.value = "";
      mPass.value  = "";
      mMsg.textContent = "";
      modalOverlay.classList.add("activo");
      mPhone.focus();
    }

    // ‚îÄ‚îÄ CERRAR MODAL ‚îÄ‚îÄ
    function cerrarModal() {
      modalOverlay.classList.remove("activo");
      mPhone.value = "";
      mPass.value  = "";
      mMsg.textContent = "";
      rolPendiente = "";
    }
    mBtnCerrar.addEventListener("click", cerrarModal);
    modalOverlay.addEventListener("click", e => { if (e.target === modalOverlay) cerrarModal(); });

    // ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ
    mBtnEntrar.addEventListener("click", async () => {
      const phone = mPhone.value.trim();
      const pass  = mPass.value.trim();

      if (!phone || !pass) {
        mMsg.textContent = "Ingres√° celular y contrase√±a.";
        return;
      }

      mBtnEntrar.disabled = true;
      mBtnEntrar.textContent = "Verificando...";
      mMsg.textContent = "";

      try {
        let admins = await dbGet("config/admins");
        if (!admins) {
          const oldPass = await dbGet("config/admin_pass");
          const dp = oldPass || "1234";
          await dbSet("config/admins/0000", { nombre: "Admin", password: dp, rol: "admin" });
          admins = { "0000": { nombre: "Admin", password: dp, rol: "admin" } };
        }

        const admin = admins[phone];
        if (admin && admin.password === pass) {
          const rol    = admin.rol || "admin";
          const nombre = admin.nombre || "Administrador";

          // Solo dejar entrar si el rol coincide con lo que pidi√≥
          if (rol !== rolPendiente && !(rol === "admin" && rolPendiente === "admin")) {
            mMsg.textContent = "‚ùå Tu cuenta no tiene acceso a esta secci√≥n.";
            mPass.value = "";
            mPass.focus();
          } else {
            sessionStorage.setItem("admin_logged", "1");
            sessionStorage.setItem("admin_phone",  phone);
            sessionStorage.setItem("admin_nombre", nombre);
            sessionStorage.setItem("admin_rol",    rol);
            cerrarModal();
            if (rol === "supervisor") mostrarPantallaSuper(nombre);
            else mostrarPantallaAdmin(nombre);
          }
        } else {
          mMsg.textContent = "‚ùå N√∫mero o contrase√±a incorrectos.";
          mPass.value = "";
          mPass.focus();
        }
      } catch(e) {
        mMsg.textContent = "‚ùå Sin conexi√≥n. Verific√° el WiFi.";
      }

      mBtnEntrar.disabled = false;
      mBtnEntrar.textContent = "Entrar";
    });

    [mPhone, mPass].forEach(el =>
      el.addEventListener("keydown", e => { if (e.key === "Enter") mBtnEntrar.click(); })
    );
  </script>

  <!-- Service Worker (PWA) -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("/sw.js")
          .catch(e => console.warn("SW error:", e));
      });
    }
  </script>
</body>
</html>
