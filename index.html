<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#7c3aed">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Sistema de Comidas</title>
  <link rel="stylesheet" href="estilo.css" />
  <style>
    body {
      background: linear-gradient(160deg, #e8d5ff 0%, #d4f0e8 50%, #ffd6a5 100%);
      min-height: 100vh;
      font-family: Arial, sans-serif;
    }

    /* ===== PANTALLAS ===== */
    .screen { display: none; min-height: 100vh; flex-direction: column; }
    .screen.activa { display: flex; }

    /* ===== BARRA SUPERIOR (todas las pantallas) ===== */
    .top-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      background: rgba(255,255,255,.50);
      border-bottom: 2px solid rgba(255,255,255,.65);
    }
    /* √çcono: zona oculta de 5 toques */
    .top-icon-tap {
      font-size: 28px;
      cursor: pointer;
      user-select: none;
      line-height: 1;
      padding: 4px;
      border-radius: 10px;
      transition: background .1s;
    }
    .top-icon-tap.flash { background: rgba(124,58,237,.18); }
    .top-bar-titulo {
      flex: 1;
      font-size: 15px;
      font-weight: 800;
      color: #4a2080;
    }
    .top-bar-titulo .tb-sub {
      font-size: 11px;
      color: #888;
      font-weight: 400;
      margin-top: 1px;
    }
    .btn-salir-top {
      padding: 6px 14px;
      border: 1.5px solid #e57373;
      border-radius: 10px;
      background: #ffebee;
      color: #c62828;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      font-family: Arial, sans-serif;
      white-space: nowrap;
    }
    .btn-salir-top:active { opacity: .8; }

    /* ===== CUERPO DEL PANEL ===== */
    .panel-body {
      flex: 1;
      padding: 20px 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-width: 440px;
      width: 100%;
      margin: 0 auto;
    }
    .panel-section-label {
      font-size: 11px;
      font-weight: 800;
      letter-spacing: 1.5px;
      color: #aaa;
      text-transform: uppercase;
      padding: 4px 2px 0;
    }

    /* ===== BOTONES DE NAVEGACI√ìN ===== */
    .panel-btn {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 18px 20px;
      text-decoration: none;
      border-radius: 20px;
      border: 2.5px solid transparent;
      font-size: 16px;
      font-weight: 800;
      box-shadow: 0 4px 14px rgba(0,0,0,.09);
      transition: transform .1s, box-shadow .1s;
      font-family: Arial, sans-serif;
      color: inherit;
    }
    .panel-btn:active { transform: scale(0.97); box-shadow: 0 2px 7px rgba(0,0,0,.09); }
    .panel-btn .pb-icon { font-size: 30px; line-height: 1; }
    .panel-btn .pb-sub { font-size: 12px; font-weight: 400; opacity: .7; margin-top: 2px; }

    .pb-registro  { background: #b5ead7; color: #1a5c40; border-color: #8dd4b8; }
    .pb-servicio  { background: #ffe0b2; color: #7a3900; border-color: #ffb74d; }
    .pb-personal  { background: #ffd6e7; color: #5c0030; border-color: #f0a8c4; }
    .pb-conteo    { background: #e3f2fd; color: #0d47a1; border-color: #90caf9; }
    .pb-menu      { background: #ffd6a5; color: #7a4200; border-color: #f5b86a; }
    .pb-lista     { background: #fce4ec; color: #880e4f; border-color: #f48fb1; }
    .pb-admin     { background: #e8d5ff; color: #4a2080; border-color: #c9a8f0; }

    /* ===== MODAL DE C√ìDIGO ===== */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.50);
      z-index: 999;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .modal-overlay.activo { display: flex; }
    .modal-box {
      background: #fff;
      border-radius: 24px;
      padding: 28px 24px;
      width: min(360px, 100%);
      box-shadow: 0 14px 44px rgba(0,0,0,.28);
      animation: fadeIn .18s ease;
    }
    @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:none; } }
    .modal-box h3 {
      margin: 0 0 6px;
      text-align: center;
      font-size: 19px;
      font-weight: 900;
      color: #4a2080;
      font-family: Arial, sans-serif;
    }
    .modal-box .modal-sub {
      text-align: center;
      font-size: 13px;
      color: #888;
      margin: 0 0 22px;
    }
    .btn-publico-modal {
      width: 100%;
      padding: 11px;
      margin-top: 10px;
      border: 1.5px solid #8dd4b8;
      border-radius: 12px;
      background: #b5ead7;
      color: #1a5c40;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      font-family: Arial, sans-serif;
    }
    .btn-publico-modal:active { opacity: .8; }
    .btn-cancelar-modal {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      border: 1.5px solid #ddd;
      border-radius: 12px;
      background: #f5f5f5;
      font-size: 13px;
      cursor: pointer;
      font-family: Arial, sans-serif;
    }
    .btn-cancelar-modal:active { opacity: .8; }
  </style>
</head>
<body>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       PANTALLA ‚Äî P√öBLICO
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="screen" id="screenPublico">
    <div class="top-bar">
      <span class="top-icon-tap" id="tapPublico">üçΩÔ∏è</span>
      <div class="top-bar-titulo">
        Sistema de Comidas
        <div class="tb-sub">Acceso p√∫blico</div>
      </div>
    </div>
    <div class="panel-body">

      <a href="PAGES/registro.html" class="panel-btn pb-registro">
        <span class="pb-icon">üìù</span>
        <div>
          <div>Registrar comidas</div>
          <div class="pb-sub">Seleccion√° tu nombre y marc√°</div>
        </div>
      </a>

      <a href="PAGES/servicio.html" class="panel-btn pb-servicio">
        <span class="pb-icon">üçΩÔ∏è</span>
        <div>
          <div>Ir a Servicio</div>
          <div class="pb-sub">Marcar platos entregados</div>
        </div>
      </a>

    </div>
  </div>


  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       PANTALLA ‚Äî SUPERVISOR
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="screen" id="screenSupervisor">
    <div class="top-bar">
      <span class="top-icon-tap" id="tapSuper">üçΩÔ∏è</span>
      <div class="top-bar-titulo">
        üëÅÔ∏è Supervisor
        <div class="tb-sub" id="superNombre"></div>
      </div>
      <button class="btn-salir-top" onclick="irPublico()">Salir</button>
    </div>
    <div class="panel-body">

      <a href="PAGES/personal.html" class="panel-btn pb-personal">
        <span class="pb-icon">üë§</span>
        <div>
          <div>Agregar personal</div>
          <div class="pb-sub">Registrar nuevo empleado</div>
        </div>
      </a>

      <a href="PAGES/conteo.html" class="panel-btn pb-conteo">
        <span class="pb-icon">üìã</span>
        <div>
          <div>Ver registrados</div>
          <div class="pb-sub">Lista de quienes marcaron</div>
        </div>
      </a>

      <a href="PAGES/menu_admin.html" class="panel-btn pb-menu">
        <span class="pb-icon">üç≤</span>
        <div>
          <div>Editar comidas</div>
          <div class="pb-sub">Cargar men√∫ del d√≠a</div>
        </div>
      </a>

    </div>
  </div>


  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       PANTALLA ‚Äî ADMIN
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="screen" id="screenAdmin">
    <div class="top-bar">
      <span class="top-icon-tap" id="tapAdmin">üçΩÔ∏è</span>
      <div class="top-bar-titulo">
        üîê Administrador
        <div class="tb-sub" id="adminNombre"></div>
      </div>
      <button class="btn-salir-top" onclick="irPublico()">Salir</button>
    </div>
    <div class="panel-body">

      <div class="panel-section-label">Acceso p√∫blico</div>

      <a href="PAGES/registro.html" class="panel-btn pb-registro">
        <span class="pb-icon">üìù</span>
        <div>
          <div>Registrar comidas</div>
          <div class="pb-sub">Seleccion√° nombre y marc√°</div>
        </div>
      </a>

      <a href="PAGES/servicio.html" class="panel-btn pb-servicio">
        <span class="pb-icon">üçΩÔ∏è</span>
        <div>
          <div>Ir a Servicio</div>
          <div class="pb-sub">Marcar platos entregados</div>
        </div>
      </a>

      <div class="panel-section-label">Supervisor</div>

      <a href="PAGES/personal.html" class="panel-btn pb-personal">
        <span class="pb-icon">üë§</span>
        <div>
          <div>Agregar personal</div>
          <div class="pb-sub">Registrar nuevo empleado</div>
        </div>
      </a>

      <a href="PAGES/conteo.html" class="panel-btn pb-conteo">
        <span class="pb-icon">üìã</span>
        <div>
          <div>Ver registrados</div>
          <div class="pb-sub">Lista de quienes marcaron</div>
        </div>
      </a>

      <a href="PAGES/menu_admin.html" class="panel-btn pb-menu">
        <span class="pb-icon">üç≤</span>
        <div>
          <div>Editar comidas</div>
          <div class="pb-sub">Cargar men√∫ del d√≠a</div>
        </div>
      </a>

      <div class="panel-section-label">Administraci√≥n</div>

      <a href="PAGES/lista_personal.html" class="panel-btn pb-lista">
        <span class="pb-icon">üë•</span>
        <div>
          <div>Lista del personal</div>
          <div class="pb-sub">Ver empleados por sector</div>
        </div>
      </a>

      <a href="PAGES/admin.html" class="panel-btn pb-admin">
        <span class="pb-icon">‚öôÔ∏è</span>
        <div>
          <div>Panel admin</div>
          <div class="pb-sub">Admins, datos y ajustes</div>
        </div>
      </a>

    </div>
  </div>


  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       MODAL ‚Äî CAMBIAR MODO
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal-box">
      <h3>üîë Cambiar modo</h3>
      <p class="modal-sub">Ingres√° el c√≥digo para cambiar</p>
      <div class="form-card" style="margin:0; border:none; background:transparent; box-shadow:none; padding:0;">
        <label class="campo">
          <span>N√∫mero de celular</span>
          <input type="tel" id="mPhone" inputmode="numeric" placeholder="Ej: 099123456">
        </label>
        <label class="campo">
          <span>Contrase√±a</span>
          <input type="password" id="mPass" placeholder="Contrase√±a">
        </label>
        <button class="btn-primario" id="mBtnEntrar" type="button">Cambiar modo</button>
        <p class="nota" id="mMsg"></p>
      </div>
      <button class="btn-publico-modal" id="mBtnPublico" type="button">
        üåê Volver a modo p√∫blico
      </button>
      <button class="btn-cancelar-modal" id="mBtnCerrar" type="button">
        Cancelar
      </button>
    </div>
  </div>


  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script>
    // ‚îÄ‚îÄ Referencias ‚îÄ‚îÄ
    const modalOverlay = document.getElementById("modalOverlay");
    const mPhone       = document.getElementById("mPhone");
    const mPass        = document.getElementById("mPass");
    const mBtnEntrar   = document.getElementById("mBtnEntrar");
    const mBtnCerrar   = document.getElementById("mBtnCerrar");
    const mBtnPublico  = document.getElementById("mBtnPublico");
    const mMsg         = document.getElementById("mMsg");

    // ‚îÄ‚îÄ Cargar modo guardado (localStorage persiste al cerrar la app) ‚îÄ‚îÄ
    function aplicarModoGuardado() {
      const modo   = localStorage.getItem("modo_actual") || "publico";
      const nombre = localStorage.getItem("modo_nombre") || "";
      activarModo(modo, nombre);
    }

    function activarModo(modo, nombre) {
      localStorage.setItem("modo_actual", modo);
      localStorage.setItem("modo_nombre", nombre);

      document.querySelectorAll(".screen").forEach(s => s.classList.remove("activa"));

      if (modo === "supervisor") {
        document.getElementById("superNombre").textContent = nombre;
        document.getElementById("screenSupervisor").classList.add("activa");
      } else if (modo === "admin") {
        document.getElementById("adminNombre").textContent = nombre;
        document.getElementById("screenAdmin").classList.add("activa");
      } else {
        document.getElementById("screenPublico").classList.add("activa");
      }
      window.scrollTo(0, 0);
    }

    function irPublico() {
      activarModo("publico", "");
    }

    // ‚îÄ‚îÄ Toque oculto: 5 veces r√°pido en el √≠cono üçΩÔ∏è ‚îÄ‚îÄ
    let tapCount = 0;
    let tapTimer = null;

    function registrarTap(el) {
      tapCount++;
      el.classList.add("flash");
      setTimeout(() => el.classList.remove("flash"), 150);

      clearTimeout(tapTimer);
      tapTimer = setTimeout(() => { tapCount = 0; }, 2000);

      if (tapCount >= 5) {
        tapCount = 0;
        clearTimeout(tapTimer);
        abrirModal();
      }
    }

    document.getElementById("tapPublico").addEventListener("click",  () => registrarTap(document.getElementById("tapPublico")));
    document.getElementById("tapSuper").addEventListener("click",    () => registrarTap(document.getElementById("tapSuper")));
    document.getElementById("tapAdmin").addEventListener("click",    () => registrarTap(document.getElementById("tapAdmin")));

    // ‚îÄ‚îÄ Modal: abrir / cerrar ‚îÄ‚îÄ
    function abrirModal() {
      mPhone.value = "";
      mPass.value  = "";
      mMsg.textContent = "";
      modalOverlay.classList.add("activo");
      mPhone.focus();
    }

    function cerrarModal() {
      modalOverlay.classList.remove("activo");
      mPhone.value = "";
      mPass.value  = "";
      mMsg.textContent = "";
    }

    mBtnCerrar.addEventListener("click", cerrarModal);
    mBtnPublico.addEventListener("click", () => { cerrarModal(); irPublico(); });
    modalOverlay.addEventListener("click", e => { if (e.target === modalOverlay) cerrarModal(); });

    // ‚îÄ‚îÄ Login / cambio de modo ‚îÄ‚îÄ
    mBtnEntrar.addEventListener("click", async () => {
      const phone = mPhone.value.trim();
      const pass  = mPass.value.trim();

      if (!phone || !pass) {
        mMsg.textContent = "Ingres√° celular y contrase√±a.";
        return;
      }

      mBtnEntrar.disabled = true;
      mBtnEntrar.textContent = "Verificando...";
      mMsg.textContent = "";

      try {
        let admins = await dbGet("config/admins");
        if (!admins) {
          const oldPass = await dbGet("config/admin_pass");
          const dp = oldPass || "1234";
          await dbSet("config/admins/0000", { nombre: "Admin", password: dp, rol: "admin" });
          admins = { "0000": { nombre: "Admin", password: dp, rol: "admin" } };
        }

        const admin = admins[phone];
        if (admin && admin.password === pass) {
          const rol    = admin.rol || "admin";
          const nombre = admin.nombre || "Administrador";
          cerrarModal();
          activarModo(rol, nombre);
        } else {
          mMsg.textContent = "‚ùå N√∫mero o contrase√±a incorrectos.";
          mPass.value = "";
          mPass.focus();
        }
      } catch(e) {
        mMsg.textContent = "‚ùå Sin conexi√≥n. Verific√° el WiFi.";
      }

      mBtnEntrar.disabled = false;
      mBtnEntrar.textContent = "Cambiar modo";
    });

    [mPhone, mPass].forEach(el =>
      el.addEventListener("keydown", e => { if (e.key === "Enter") mBtnEntrar.click(); })
    );

    // ‚îÄ‚îÄ Iniciar ‚îÄ‚îÄ
    aplicarModoGuardado();
  </script>

  <!-- Service Worker (PWA) -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("/sw.js")
          .catch(e => console.warn("SW error:", e));
      });
    }
  </script>
</body>
</html>
