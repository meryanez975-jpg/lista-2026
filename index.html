<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- PWA -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#7c3aed">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Sistema de Comidas</title>
  <link rel="stylesheet" href="estilo.css" />
  <style>
    body {
      background: linear-gradient(160deg, #e8d5ff 0%, #d4f0e8 50%, #ffd6a5 100%);
      min-height: 100vh;
    }
    /* Modal de login */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.45);
      z-index: 999;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .modal-overlay.activo { display: flex; }
    .modal-box {
      background: #fff;
      border-radius: 22px;
      padding: 28px 24px;
      width: min(400px, 100%);
      box-shadow: 0 12px 40px rgba(0,0,0,.25);
      animation: fadeIn .2s ease;
    }
    .modal-box h3 {
      margin: 0 0 20px;
      text-align: center;
      font-size: 20px;
      color: #4a2080;
    }
    /* Bot√≥n lock discreto abajo a la derecha */
    .btn-lock {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: none;
      background: rgba(180,160,220,.35);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background .2s;
    }
    .btn-lock:active { background: rgba(180,160,220,.7); }
    /* Barra de usuario logueado */
    .admin-bar {
      display: none;
      background: #f0e6ff;
      border: 1.5px solid #c9a8f0;
      border-radius: 14px;
      padding: 10px 14px;
      margin-bottom: 16px;
      align-items: center;
      justify-content: space-between;
      font-size: 13px;
      color: #4a2080;
      font-weight: 700;
    }
    .admin-bar.visible { display: flex; }
    .btn-salir-index {
      padding: 6px 14px;
      border: 1.5px solid #e57373;
      border-radius: 10px;
      background: #ffebee;
      color: #c62828;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
    }
    /* ===== MEN√ö HAMBURGUESA ===== */
    .hamb-container {
      display: flex;
      gap: 16px;
      justify-content: center;
      margin: 12px 0 8px;
    }
    .hamb-wrap {
      position: relative;
      flex: 1;
      min-width: 130px;
      max-width: 200px;
    }
    .btn-hamb {
      width: 100%;
      padding: 20px 12px;
      border: none;
      border-radius: 20px;
      font-size: 15px;
      font-weight: 800;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,.15);
      transition: transform .15s, box-shadow .15s;
      letter-spacing: .5px;
    }
    .btn-hamb:active { transform: scale(.97); box-shadow: 0 2px 8px rgba(0,0,0,.12); }
    .btn-hamb .hamb-icon { font-size: 28px; }
    .btn-hamb .hamb-lineas { font-size: 18px; letter-spacing: 1px; opacity: .85; }
    .btn-hamb.registro-color { background: linear-gradient(135deg, #b39ddb, #7e57c2); color: #fff; }
    .btn-hamb.servicio-color { background: linear-gradient(135deg, #80cbc4, #26a69a); color: #fff; }
    .hamb-menu {
      position: absolute;
      top: calc(100% + 10px);
      left: 0;
      right: 0;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 8px 28px rgba(0,0,0,.18);
      z-index: 100;
      overflow: hidden;
      animation: fadeIn .15s ease;
    }
    .hamb-menu a {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 15px 16px;
      text-decoration: none;
      color: #333;
      font-size: 15px;
      font-weight: 600;
      border-bottom: 1px solid #f0f0f0;
      transition: background .15s;
    }
    .hamb-menu a:last-child { border-bottom: none; }
    .hamb-menu a:hover, .hamb-menu a:active { background: #f5f5f5; }
    /* √çtems solo visibles para supervisor/admin */
    .solo-super { display: none; }
    .solo-super.visible { display: flex; }
  </style>
</head>
<body>

  <!-- Modal de login admin -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal-box">
      <h3>üîê Acceso administrador</h3>
      <div class="form-card" style="margin:0; border:none; background:transparent; box-shadow:none; padding:0;">
        <label class="campo">
          <span>N√∫mero de celular</span>
          <input type="tel" id="mPhone" inputmode="numeric" placeholder="Ej: 099123456">
        </label>
        <label class="campo">
          <span>Contrase√±a</span>
          <input type="password" id="mPass" placeholder="Contrase√±a">
        </label>
        <button class="btn-primario" id="mBtnEntrar" type="button">Entrar</button>
        <p class="nota" id="mMsg"></p>
      </div>
      <button id="mBtnCerrar" type="button"
              style="margin-top:14px; width:100%; padding:10px; border:1.5px solid #ddd;
                     border-radius:12px; background:#f5f5f5; font-size:14px; cursor:pointer;">
        Cancelar
      </button>
    </div>
  </div>

  <main class="menu" style="margin-top:20px;">
    <p class="menu-titulo">SISTEMA DE COMIDAS</p>

    <!-- Barra visible solo cuando est√° logueado -->
    <div class="admin-bar" id="adminBar">
      <span id="adminBarNombre">üë§ Administrador</span>
      <button class="btn-salir-index" id="btnSalirIndex" type="button">Salir</button>
    </div>

    <!-- Bot√≥n ADMINISTRACI√ìN: solo para rol admin -->
    <a class="card-btn admin hidden" id="btnAdmin" href="PAGES/admin.html">
      <span class="icon">üîê</span>
      <span class="text">ADMINISTRACI√ìN</span>
    </a>

    <!-- Dos men√∫s hamburguesa -->
    <div class="hamb-container">

      <!-- ‚ò∞ REGISTRO -->
      <div class="hamb-wrap">
        <button class="btn-hamb registro-color" id="hambRegistro" type="button">
          <span class="hamb-icon">‚úèÔ∏è</span>
          <span class="hamb-lineas">‚ò∞</span>
          <span>REGISTRO</span>
        </button>
        <div class="hamb-menu hidden" id="menuRegistro">
          <a href="PAGES/registro.html">‚úèÔ∏è Registro</a>
          <a href="PAGES/lista_personal.html" class="solo-super" id="linkListaPersonal">üë• Lista Personal</a>
        </div>
      </div>

      <!-- ‚ò∞ SERVICIO -->
      <div class="hamb-wrap">
        <button class="btn-hamb servicio-color" id="hambServicio" type="button">
          <span class="hamb-icon">üçΩÔ∏è</span>
          <span class="hamb-lineas">‚ò∞</span>
          <span>SERVICIO</span>
        </button>
        <div class="hamb-menu hidden" id="menuServicio">
          <a href="PAGES/servicio.html">üçΩÔ∏è Servicio</a>
          <a href="PAGES/conteo.html" class="solo-super" id="linkConteo">üßÆ Conteo</a>
        </div>
      </div>

    </div>
  </main>

  <!-- Bot√≥n lock discreto -->
  <button class="btn-lock" id="btnLock" title="Administradores">üîí</button>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script>
    const modalOverlay      = document.getElementById("modalOverlay");
    const mPhone            = document.getElementById("mPhone");
    const mPass             = document.getElementById("mPass");
    const mBtnEntrar        = document.getElementById("mBtnEntrar");
    const mBtnCerrar        = document.getElementById("mBtnCerrar");
    const mMsg              = document.getElementById("mMsg");
    const adminBar          = document.getElementById("adminBar");
    const adminBarNombre    = document.getElementById("adminBarNombre");
    const btnSalirIndex     = document.getElementById("btnSalirIndex");
    const btnAdmin          = document.getElementById("btnAdmin");
    const btnLock           = document.getElementById("btnLock");
    const hambRegistro      = document.getElementById("hambRegistro");
    const hambServicio      = document.getElementById("hambServicio");
    const menuRegistro      = document.getElementById("menuRegistro");
    const menuServicio      = document.getElementById("menuServicio");
    const linkListaPersonal = document.getElementById("linkListaPersonal");
    const linkConteo        = document.getElementById("linkConteo");

    // ===== REVISAR SI YA HAY SESI√ìN =====
    if (sessionStorage.getItem("admin_logged") === "1") {
      const rol = sessionStorage.getItem("admin_rol") || "admin";
      mostrarModoLogueado(sessionStorage.getItem("admin_nombre") || "Administrador", rol);
    }

    // ===== HAMBURGUESAS: abrir/cerrar =====
    hambRegistro.addEventListener("click", e => {
      e.stopPropagation();
      menuServicio.classList.add("hidden");
      menuRegistro.classList.toggle("hidden");
    });

    hambServicio.addEventListener("click", e => {
      e.stopPropagation();
      menuRegistro.classList.add("hidden");
      menuServicio.classList.toggle("hidden");
    });

    document.addEventListener("click", () => {
      menuRegistro.classList.add("hidden");
      menuServicio.classList.add("hidden");
    });

    // ===== ABRIR MODAL =====
    btnLock.addEventListener("click", () => {
      if (sessionStorage.getItem("admin_logged") === "1") {
        if ((sessionStorage.getItem("admin_rol") || "admin") === "admin") {
          window.location.href = "PAGES/admin.html";
        }
        return;
      }
      modalOverlay.classList.add("activo");
      mPhone.focus();
    });

    // ===== CERRAR MODAL =====
    mBtnCerrar.addEventListener("click", cerrarModal);
    modalOverlay.addEventListener("click", e => {
      if (e.target === modalOverlay) cerrarModal();
    });

    function cerrarModal() {
      modalOverlay.classList.remove("activo");
      mPhone.value = "";
      mPass.value  = "";
      mMsg.textContent = "";
    }

    // ===== LOGIN =====
    mBtnEntrar.addEventListener("click", async () => {
      const phone = mPhone.value.trim();
      const pass  = mPass.value.trim();

      if (!phone || !pass) {
        mMsg.textContent = "Ingres√° celular y contrase√±a.";
        return;
      }

      mBtnEntrar.disabled = true;
      mBtnEntrar.textContent = "Verificando...";
      mMsg.textContent = "";

      try {
        let admins = await dbGet("config/admins");
        if (!admins) {
          const oldPass = await dbGet("config/admin_pass");
          const defaultPass = oldPass || "1234";
          await dbSet("config/admins/0000", { nombre: "Admin", password: defaultPass, rol: "admin" });
          admins = { "0000": { nombre: "Admin", password: defaultPass, rol: "admin" } };
        }

        const admin = admins[phone];
        if (admin && admin.password === pass) {
          const rol = admin.rol || "admin"; // sin campo rol = admin (compatibilidad)
          sessionStorage.setItem("admin_logged", "1");
          sessionStorage.setItem("admin_phone", phone);
          sessionStorage.setItem("admin_nombre", admin.nombre || "Administrador");
          sessionStorage.setItem("admin_rol", rol);
          cerrarModal();
          mostrarModoLogueado(admin.nombre || "Administrador", rol);
        } else {
          mMsg.textContent = "‚ùå N√∫mero o contrase√±a incorrectos.";
          mPass.value = "";
          mPass.focus();
        }
      } catch(e) {
        mMsg.textContent = "‚ùå Sin conexi√≥n. Verifica el WiFi.";
      }

      mBtnEntrar.disabled = false;
      mBtnEntrar.textContent = "Entrar";
    });

    [mPhone, mPass].forEach(el =>
      el.addEventListener("keydown", e => { if (e.key === "Enter") mBtnEntrar.click(); })
    );

    // ===== MOSTRAR SEG√öN ROL =====
    function mostrarModoLogueado(nombre, rol) {
      const etiqueta = rol === "supervisor" ? "üëÅÔ∏è Supervisor" : "üë§ Admin";
      adminBarNombre.textContent = `${etiqueta}: ${nombre}`;
      adminBar.classList.add("visible");
      btnLock.textContent = "‚öôÔ∏è";

      // Admin: ve bot√≥n Administraci√≥n + ‚öôÔ∏è va a admin.html
      if (rol === "admin") {
        btnAdmin.classList.remove("hidden");
      }

      // Supervisor y admin: ven Lista Personal y Conteo en los hamburguesas
      linkListaPersonal.classList.add("visible");
      linkConteo.classList.add("visible");
    }

    // ===== SALIR =====
    btnSalirIndex.addEventListener("click", () => {
      sessionStorage.removeItem("admin_logged");
      sessionStorage.removeItem("admin_phone");
      sessionStorage.removeItem("admin_nombre");
      sessionStorage.removeItem("admin_rol");
      btnAdmin.classList.add("hidden");
      linkListaPersonal.classList.remove("visible");
      linkConteo.classList.remove("visible");
      adminBar.classList.remove("visible");
      btnLock.textContent = "üîí";
    });
  </script>

  <!-- Registro del Service Worker (PWA) -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("/sw.js")
          .catch((e) => console.warn("SW error:", e));
      });
    }
  </script>
</body>
</html>
